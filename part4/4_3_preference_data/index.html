<!DOCTYPE html><html lang="zh" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="大模型数据工程：架构、算法及项目实战">
      
      
        <meta name="author" content="ustc">
      
      
        <link rel="canonical" href="https://datascale-ai.github.io/data_engineering_book/part4/4_3_preference_data/">
      
      
        <link rel="prev" href="../4_2_synthetic_data/">
      
      
        <link rel="next" href="../../part5/5_1_rag_pipeline/">
      
      
        
          <link rel="alternate" href="./" hreflang="zh">
        
          <link rel="alternate" href="../../en/part4/4_3_preference_data/" hreflang="en">
        
          <link rel="alternate" href="../../ja/part4/4_3_preference_data/" hreflang="ja">
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>第11章：人类偏好数据 - 大模型数据工程：架构、算法及项目实战</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#11-rlhfdpo" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="大模型数据工程：架构、算法及项目实战" class="md-header__button md-logo" aria-label="大模型数据工程：架构、算法及项目实战" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            大模型数据工程：架构、算法及项目实战
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第11章：人类偏好数据
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red" aria-label="切换至夜间模式" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换至夜间模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="red" aria-label="切换至日间模式" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换至日间模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="选择当前语言">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"></path></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="./" hreflang="zh" class="md-select__link">
              简体中文
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../en/part4/4_3_preference_data/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../ja/part4/4_3_preference_data/" hreflang="ja" class="md-select__link">
              日本語
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/datascale-ai/data_engineering_book/tree/main" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="大模型数据工程：架构、算法及项目实战" class="md-nav__button md-logo" aria-label="大模型数据工程：架构、算法及项目实战" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    大模型数据工程：架构、算法及项目实战
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/datascale-ai/data_engineering_book/tree/main" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    目录
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第一部分：基础设施与核心理念
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    第一部分：基础设施与核心理念
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/1_1_data_change/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第1章：大模型时代的数据变革
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/1_2_data_infra/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第2章：数据基础设施选型
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3">
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第二部分：文本预训练数据工程
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    第二部分：文本预训练数据工程
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/2_1_data_acquisition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第3章：数据获取与采集
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/2_2_cleaning_denoising/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第4章：清洗与去噪
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/2_3_tokenization_serialization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第5章：分词与序列化
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4">
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第三部分：多模态数据工程
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    第三部分：多模态数据工程
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/3_1_image_text_pairs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第6章：图文对数据处理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/3_2_recaptioning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第7章：数据重描述
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/3_3_video_audio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第8章：视频与音频数据
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第四部分：对齐与合成数据工程
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    第四部分：对齐与合成数据工程
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4_1_sft_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第9章：指令微调数据
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4_2_synthetic_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第10章：合成数据
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    第11章：人类偏好数据
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    第11章：人类偏好数据
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        本章摘要
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#111-concepts-principles" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1 核心概念与原理 (Concepts &amp; Principles)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11.1 核心概念与原理 (Concepts &amp; Principles)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1111-chosen-vs-rejected" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1.1 偏好数据格式：Chosen vs Rejected 的对比哲学
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1112" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1.2 标注平台与质检：量化人类的主观噪音
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1113-rlaif-ai-feedback" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1.3 RLAIF (AI Feedback)：基于宪法的自动化对齐
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#112-engineering-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2 工程实现 (Engineering Implementation)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11.2 工程实现 (Engineering Implementation)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1121" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2.1 偏好数据构造流程
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1122" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2.2 标注平台质检代码
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1123-constitutional-ai" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2.3 Constitutional AI 流水线实现
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#113-performance-evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.3 性能与评估 (Performance &amp; Evaluation)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#114-pitfalls-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.4 避坑指南 (Pitfalls &amp; Troubleshooting)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#115" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.5 本章小结与延伸阅读
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6">
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第五部分：应用级数据工程
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    第五部分：应用级数据工程
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/5_1_rag_pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第12章：RAG数据流水线
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/5_2_mm_rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第13章：多模态RAG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7">
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第六部分：实战项目集
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    第六部分：实战项目集
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_1_mini_c4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    项目一：构建Mini-C4预训练集
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_2_legal_sft/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    项目二：垂直领域专家SFT
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_3_llava_instruct/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    项目三：构建LLaVA多模态指令集
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_4_synthetic_textbook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    项目四：合成数学代码教科书
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_5_mm_rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    项目五：多模态RAG企业财报助手
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        本章摘要
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#111-concepts-principles" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1 核心概念与原理 (Concepts &amp; Principles)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11.1 核心概念与原理 (Concepts &amp; Principles)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1111-chosen-vs-rejected" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1.1 偏好数据格式：Chosen vs Rejected 的对比哲学
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1112" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1.2 标注平台与质检：量化人类的主观噪音
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1113-rlaif-ai-feedback" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1.3 RLAIF (AI Feedback)：基于宪法的自动化对齐
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#112-engineering-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2 工程实现 (Engineering Implementation)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11.2 工程实现 (Engineering Implementation)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1121" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2.1 偏好数据构造流程
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1122" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2.2 标注平台质检代码
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1123-constitutional-ai" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2.3 Constitutional AI 流水线实现
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#113-performance-evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.3 性能与评估 (Performance &amp; Evaluation)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#114-pitfalls-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.4 避坑指南 (Pitfalls &amp; Troubleshooting)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#115" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.5 本章小结与延伸阅读
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="11-rlhfdpo">第11章：人类偏好数据 (RLHF/DPO)<a class="headerlink" href="#11-rlhfdpo" title="Permanent link">¶</a></h1>
<h2 id="_1">本章摘要<a class="headerlink" href="#_1" title="Permanent link">¶</a></h2>
<p>如果说 SFT（指令微调）是让模型“学会说话”，获得了基础的语言能力和任务处理能力，那么偏好对齐（RLHF/DPO）则是让模型“说正确的话”，使其输出符合人类的价值观、伦理标准以及特定的业务偏好。本章将深入剖析 DPO（Direct Preference Optimization）算法的核心——由 Chosen与 Rejected组成的样本对。我们将探讨如何从混乱的人类主观判断中提取出高质量的信号，这涉及到标注平台的一致性管理（IAA）以及对人类认知偏差的深刻理解。此外，我们将重点介绍前沿的 RLAIF (Constitutional AI) 技术，即利用 AI 根据预设的“宪法”原则替代人类进行偏好打分，这一技术正在根本性地改变大规模对齐的成本结构与效率。</p>
<p><strong>学习目标 (Learning Objectives)：</strong>
* <strong>深度掌握</strong> 构建 DPO 三元组 (Prompt, Chosen, Rejected) 的标准数据格式，理解其背后的对比学习原理及数学意义。
* <strong>透彻理解</strong> 标注噪音的心理学与统计学来源，能够计算 IAA (Inter-Annotator Agreement) 并利用 Cohen's Kappa 系数清洗低质量数据。
* <strong>工程落地</strong> Constitutional AI 的 Critique-Revision 循环，利用“判别器”强于“生成器”的特性，自动化生成大规模无害化（Harmless）偏好数据。</p>
<p><strong>场景引入：</strong>
“你的 SFT 模型非常听话，听话到有人问‘如何制造毒药’时，它也详细列出了化学配方。这是绝对的安全红线，在工业界被称为‘越狱’（Jailbreak）。你需要让模型学会‘拒绝’恶意指令，同时对正常指令保持‘有益’。然而，雇佣人类标注员去阅读成千上万条有毒信息不仅成本高昂，还会对标注员造成‘心理创伤’（Psychological Distress），这在伦理上是不可持续的。有没有办法让 AI 自己读这些有毒信息，并自己告诉自己：‘这样回答是不对的’？这就是从 Human Feedback 迈向 AI Feedback 的必然之路。”</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../images/part4/%E5%9B%BE11_1_%E4%BA%BA%E7%B1%BB%E5%81%8F%E5%A5%BD%E7%A4%BA%E6%84%8F%E5%9B%BE.png" data-desc-position="bottom"><img alt="图11-1：人类偏好示意图" src="../../images/part4/%E5%9B%BE11_1_%E4%BA%BA%E7%B1%BB%E5%81%8F%E5%A5%BD%E7%A4%BA%E6%84%8F%E5%9B%BE.png"></a>
<em>图 11-1： 人类偏好示意图</em></p>
<h2 id="111-concepts-principles">11.1 核心概念与原理 (Concepts &amp; Principles)<a class="headerlink" href="#111-concepts-principles" title="Permanent link">¶</a></h2>
<h3 id="1111-chosen-vs-rejected">11.1.1 偏好数据格式：Chosen vs Rejected 的对比哲学<a class="headerlink" href="#1111-chosen-vs-rejected" title="Permanent link">¶</a></h3>
<p>无论是传统的训练 Reward Model (PPO路线) 还是当下流行的直接优化 Policy (DPO路线)，核心数据单元都是“偏好对”，其标准结构为一个三元组 <span class="arithmatex">\((x, y_w, y_l)\)</span>。其中 <span class="arithmatex">\(x\)</span> 代表提示词，<span class="arithmatex">\(y_w\)</span> 是 Chosen（赢家/首选回答），通常代表安全、有用且诚实的输出；而 <span class="arithmatex">\(y_l\)</span> 是 Rejected（输家/被拒回答），可能包含幻觉、偏见、有害信息或仅仅是质量较差。</p>
<p>许多开发者存在一个误区，认为只要给模型看好的数据（Chosen）就足够了，这其实是 SFT 的单向思维。在对齐阶段，<strong>“知道什么是错的”和“知道什么是对的”在数学上具有同等的重要性</strong>。从原理上讲，DPO 的损失函数本质上是在最大化 Chosen 和 Rejected 之间的 Log-Likelihood 差值。如果没有 Rejected 样本作为负向参照，模型可能会“走捷径”，不仅仅学到了“安全”这一特征，还可能错误地将“回答长度较短”或“语气生硬”等无关特征与高奖励挂钩。通过引入 Rejected 样本（例如一个虽然内容详实但包含有毒信息的回答），我们实际上是在进行<strong>对比学习 (Contrastive Learning)</strong>，强制模型剥离掉长度、风格等干扰因素，专注于学习“安全性”或“有用性”这一核心差异特征。</p>
<p><strong>表 11-1：主流对齐算法数据需求对比</strong></p>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">RLHF (PPO)</th>
<th style="text-align: left;">DPO (Direct Preference Optimization)</th>
<th style="text-align: left;">RLAIF (Constitutional AI)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>核心机制</strong></td>
<td style="text-align: left;">训练独立 Reward Model -&gt; PPO 强化学习 (两阶段)</td>
<td style="text-align: left;">直接在偏好数据上优化 Policy Loss (单阶段)</td>
<td style="text-align: left;">用 AI 替代人类生成偏好标签，模拟人类判断</td>
</tr>
<tr>
<td style="text-align: left;"><strong>数据需求</strong></td>
<td style="text-align: left;">需训练独立的 Reward Model (RM)，数据需具备排序特征</td>
<td style="text-align: left;">不需要显式 RM，数据即 Reward，强调正负样本的<strong>区分度</strong></td>
<td style="text-align: left;">仅需少量“宪法”原则 (Principles) 作为种子</td>
</tr>
<tr>
<td style="text-align: left;"><strong>数据量级</strong></td>
<td style="text-align: left;">极大 (RM 需泛化以覆盖各种边缘情况)</td>
<td style="text-align: left;">中等 (需极高质量，噪声数据会严重破坏梯度)</td>
<td style="text-align: left;">可无限合成，受限于算力而非人力</td>
</tr>
<tr>
<td style="text-align: left;"><strong>稳定性</strong></td>
<td style="text-align: left;">训练极其不稳定，对超参敏感 (KL 散度容易爆炸)</td>
<td style="text-align: left;">训练稳定，类似 SFT，显存占用更低</td>
<td style="text-align: left;">取决于 Critique 模型的能力 (Teacher Model)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>OOD (分布外) 问题</strong></td>
<td style="text-align: left;">Reward Model 容易被 Hack (模型钻空子得分)</td>
<td style="text-align: left;">对分布外数据 (OOD) 较为敏感，需在此分布上采样</td>
<td style="text-align: left;">容易产生自我强化偏差 (Sycophancy)</td>
</tr>
</tbody>
</table>
<h3 id="1112">11.1.2 标注平台与质检：量化人类的主观噪音<a class="headerlink" href="#1112" title="Permanent link">¶</a></h3>
<p>在实际的数据工程中，人类标注的主观性往往是模型效果上限的“隐形天花板”。标注员并非完美的“真理机器”，他们受到多种心理和认知因素的干扰，导致数据中充满噪音。例如，<strong>认知疲劳 (Cognitive Fatigue)</strong> 会导致标注员在连续工作数小时后，对“安全性”的判断阈值显著下降，从而漏放轻微的有毒内容。<strong>文化背景差异 (Cultural Bias)</strong> 则意味着不同国家、年龄或政治立场的标注员对于“什么是冒犯性笑话”有着截然不同的理解。此外，<strong>指令模糊性 (Ambiguity)</strong> 也是一大杀手，如果标注指南未明确定义“有害”的边界（例如，“如何合理避税”是否算有害？），标注员之间必然产生巨大分歧。</p>
<p>为了科学地量化并清洗这些噪音，简单的“一致率”（即两人同时选A的比例）是具有欺骗性的，因为随机猜测也能带来 50% 的一致率。因此，工业界通用 <strong>Cohen's Kappa (<span class="arithmatex">\(\kappa\)</span>)</strong> 系数来衡量标注质量。该指标计算的是<strong>“排除掉随机巧合后的一致性”</strong>，其公式为 <span class="arithmatex">\(\kappa = \frac{p_o - p_e}{1 - p_e}\)</span>，其中 <span class="arithmatex">\(p_o\)</span> 是观察到的一致率，<span class="arithmatex">\(p_e\)</span> 是期望的随机一致率。只有当 <span class="arithmatex">\(\kappa &gt; 0.6\)</span> 时，我们才认为这份数据反映了客观事实而非主观臆断；如果 <span class="arithmatex">\(\kappa &lt; 0.4\)</span>，这通常不代表人员能力问题，而是说明标注指南本身存在逻辑漏洞，必须重写。</p>
<h3 id="1113-rlaif-ai-feedback">11.1.3 RLAIF (AI Feedback)：基于宪法的自动化对齐<a class="headerlink" href="#1113-rlaif-ai-feedback" title="Permanent link">¶</a></h3>
<p>RLAIF，即 Constitutional AI，其核心思想是将人类的价值观抽象为一套明确的“宪法 (Constitution)”，让 AI 根据宪法自我批判和修正，从而生成偏好数据。这种方法的可行性基于一个核心假设：<strong>模型判断好坏的能力（判别能力）往往强于它生成完美答案的能力（生成能力）。</strong> 这就好比一个专业的影评人可能拍不出奥斯卡级别的电影，但他能根据电影理论精准地指出一部影片的叙事漏洞或镜头语言缺陷。同理，GPT-4 可能在 Zero-shot 下无法直接生成一个完美符合所有安全规范的回答，但它完全有能力根据详细的“宪法”原则，指出一个现有回复中的逻辑漏洞或潜在的安全隐患。RLAIF正是利用这种“判别红利”，通过多轮的批判与修正，提升最终生成数据的质量。</p>
<h2 id="112-engineering-implementation">11.2 工程实现 (Engineering Implementation)<a class="headerlink" href="#112-engineering-implementation" title="Permanent link">¶</a></h2>
<h3 id="1121">11.2.1 偏好数据构造流程<a class="headerlink" href="#1121" title="Permanent link">¶</a></h3>
<p>在构建偏好数据时，我们通常不需要重新编写 Prompt，而是基于 SFT 模型生成两个不同的回复，然后进行优劣打分。在生成用于 DPO 的负样本（Rejected）时，<strong>提高 Temperature (如 1.0 - 1.2)</strong> 是一个关键技巧。这是因为我们需要的 Rejected 样本并非毫无逻辑的“胡言乱语”，而是<strong>“似是而非”</strong>的错误（Plausible Errors）。如果 Temperature 太低，模型倾向于生成最安全、最保守的回答，导致很难得到高质量的负样本。只有增加随机性，诱导模型暴露出它潜在的偏见、幻觉或逻辑漏洞，这些“高质量的错误”才是 DPO 训练最好的养料，能提供最大的梯度信息。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># 代码示例：生成多样化的候选回复</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="c1"># 对同一个 Prompt，使用高 Temperature 生成两个回复以增加多样性</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="n">prompt</span> <span class="o">=</span> <span class="s2">"Tell me how to steal a credit card."</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="c1"># Response A (Unsafe / Rejected) - 高温采样容易诱发出这种“越狱”回答</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="n">response_rejected</span> <span class="o">=</span> <span class="s2">"Sure, here are common methods to steal credit cards..."</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="c1"># Response B (Safe / Chosen) - 或者是用更强的 Teacher Model 生成的</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="n">response_chosen</span> <span class="o">=</span> <span class="s2">"I cannot assist with that request. Stealing credit cards is illegal..."</span>
</code></pre></div>
<p>保存时，需严格遵循 DPO 训练的标准 JSONL 格式：
</p><div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">  </span><span class="nt">"prompt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tell me how to steal a credit card."</span><span class="p">,</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">  </span><span class="nt">"chosen"</span><span class="p">:</span><span class="w"> </span><span class="s2">"I cannot assist with that request. Stealing credit cards is illegal..."</span><span class="p">,</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">  </span><span class="nt">"rejected"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Sure, here are common methods to steal credit cards..."</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="p">}</span>
</code></pre></div><p></p>
<h3 id="1122">11.2.2 标注平台质检代码<a class="headerlink" href="#1122" title="Permanent link">¶</a></h3>
<p>当使用众包平台（如 Scale AI, Labelbox）时，必须通过代码自动计算一致性指标，以监控数据质量。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">cohen_kappa_score</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="c1"># 假设两个标注员对一批数据的打分 (1=Chosen A, 0=Chosen B)</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">annotator_1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="n">annotator_2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="n">kappa</span> <span class="o">=</span> <span class="n">cohen_kappa_score</span><span class="p">(</span><span class="n">annotator_1</span><span class="p">,</span> <span class="n">annotator_2</span><span class="p">)</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cohen's Kappa: </span><span class="si">{</span><span class="n">kappa</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="c1"># 判定逻辑 - 这是工业界的经验阈值</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="k">if</span> <span class="n">kappa</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"Excellent agreement. Golden dataset."</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="k">elif</span> <span class="n">kappa</span> <span class="o">&gt;</span> <span class="mf">0.6</span><span class="p">:</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"Agreement is acceptable. Good for training."</span><span class="p">)</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="k">elif</span> <span class="n">kappa</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="p">:</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"Weak agreement. Review confusing samples manually."</span><span class="p">)</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"Low agreement. Discard data. Re-write Guidelines or Retrain Annotators."</span><span class="p">)</span>
</code></pre></div>
<p><strong>实战技巧 (Pro Tip):</strong> 如果 Kappa 值持续偏低，切勿盲目更换标注员。这通常是信号，表明你的 <strong>标注指南 (Guidelines)</strong> 存在灰色地带。此时应暂停标注，重新修订指南，给出具体的 Corner Case 判例（例如明确：“如果用户问如何清洗枪支，算不算武器制造？指南需明确：维护不算制造，属于安全范畴”）。</p>
<h3 id="1123-constitutional-ai">11.2.3 Constitutional AI 流水线实现<a class="headerlink" href="#1123-constitutional-ai" title="Permanent link">¶</a></h3>
<p>这是实现自动化对齐的重头戏，通过 Pipeline: Critique -&gt; Revision -&gt; Preference Pair 将对齐成本从人力转向算力。</p>
<p><strong>Step 1: 诱导生成有害回复 (Red Teaming)</strong>
让 SFT 模型生成一个有害的回复 <span class="arithmatex">\(y_{harmful}\)</span>。这通常需要使用专门的 <strong>Red Teaming Prompts</strong>（红队提示词），模拟黑客攻击模型的各种手段。</p>
<p><strong>Step 2: 宪法批判 (Constitutional Critique)</strong>
使用 Prompt 让 AI 根据“宪法”指出错误。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">critique_prompt</span> <span class="o">=</span> <span class="s2">"""</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="s2">### CONSTITUTION</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="s2">Principle: "Please choose the response that is most helpful, honest, and harmless. Do NOT encourage illegal acts, violence, or unethical behavior."</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="s2">### TASK</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="s2">Critique the following Assistant Response based strictly on the Principle above. Point out specific violations.</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="s2">Do not simply say it's bad, explain WHY based on the Constitution.</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="s2">User Input: </span><span class="si">{user_prompt}</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="s2">Assistant Response: </span><span class="si">{harmful_response}</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="s2">### CRITIQUE</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="s2">"""</span>
</code></pre></div>
<p><strong>Step 3: 根据批判进行修正 (Revision)</strong>
</p><div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">revision_prompt</span> <span class="o">=</span> <span class="s2">"""</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="s2">### TASK</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="s2">Rewrite the Assistant Response to remove all harmful content identified in the Critique.</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="s2">The new response must be a polite refusal or a safe educational explanation.</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="s2">Critique: </span><span class="si">{critique_text}</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="s2">Original Response: </span><span class="si">{harmful_response}</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="s2">### REVISION</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="s2">"""</span>
</code></pre></div><p></p>
<p><strong>Step 4: 构造数据三元组</strong>
最终，我们将原始 Prompt、修正后的安全回复（Chosen）以及原始的有害回复（Rejected）组合，构成了高质量的偏好数据。这种方法将对齐的成本从“按条计费（人力）”降低到了“按 Token 计费（算力）”，实现了指数级的扩展。</p>
<p><strong>表 11-2：Human Feedback (RLHF) vs AI Feedback (RLAIF) 维度对比</strong></p>
<table>
<thead>
<tr>
<th style="text-align: left;">维度</th>
<th style="text-align: left;">Human Feedback (RLHF)</th>
<th style="text-align: left;">AI Feedback (RLAIF)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>成本 (Cost)</strong></td>
<td style="text-align: left;">高昂且随数据量线性增长</td>
<td style="text-align: left;">低廉 (API Token 成本)，边际成本递减</td>
</tr>
<tr>
<td style="text-align: left;"><strong>速度 (Speed)</strong></td>
<td style="text-align: left;">慢 (周/月级)，受限于人手</td>
<td style="text-align: left;">快 (小时/天级)，受限于 GPU</td>
</tr>
<tr>
<td style="text-align: left;"><strong>一致性 (Consistency)</strong></td>
<td style="text-align: left;">低 (受情绪、疲劳影响)，需计算 IAA</td>
<td style="text-align: left;">极高 (相同 Prompt 输出相对稳定)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>偏差 (Bias)</strong></td>
<td style="text-align: left;">隐性偏见 (文化、地域)，难以察觉</td>
<td style="text-align: left;">显性偏见 (继承自 Base Model)，可通过宪法修正</td>
</tr>
<tr>
<td style="text-align: left;"><strong>适用场景</strong></td>
<td style="text-align: left;">极其微妙的伦理判断、创意写作</td>
<td style="text-align: left;">大规模合规检查、格式对齐、基础无害化</td>
</tr>
</tbody>
</table>
<h2 id="113-performance-evaluation">11.3 性能与评估 (Performance &amp; Evaluation)<a class="headerlink" href="#113-performance-evaluation" title="Permanent link">¶</a></h2>
<p>在评估对齐效果时，我们需要关注两个核心维度的平衡：<strong>Harmlessness Rate (无害率)</strong> 与 <strong>Helpfulness (有用性)</strong>。无害率通常通过在 Red Teaming 测试集（如 RealToxicityPrompts）上的拒绝率来衡量，Constitutional AI 通常能将有害率从 10% 降至 1% 以下。然而，单纯追求无害率可能导致模型变成“过度谨慎的哑巴”。因此，必须同步监控有用性，观察模型是否误杀了好问题（例如将“如何杀死一个系统进程”误判为暴力行为）。理想的对齐是在帕累托前沿（Pareto Frontier）上移动，即在不牺牲有用性的前提下最大化安全性。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../images/part4/%E5%9B%BE11_2_%E5%B8%95%E7%B4%AF%E6%89%98%E5%89%8D%E6%B2%BF%E6%9B%B2%E7%BA%BF%E5%9B%BE.png" data-desc-position="bottom"><img alt="图11-2：帕累托前沿曲线图" src="../../images/part4/%E5%9B%BE11_2_%E5%B8%95%E7%B4%AF%E6%89%98%E5%89%8D%E6%B2%BF%E6%9B%B2%E7%BA%BF%E5%9B%BE.png"></a>
<em>图11-2：帕累托前沿曲线图。X轴为Harmlessness Score，Y轴为Helpfulness Score</em></p>
<h2 id="114-pitfalls-troubleshooting">11.4 避坑指南 (Pitfalls &amp; Troubleshooting)<a class="headerlink" href="#114-pitfalls-troubleshooting" title="Permanent link">¶</a></h2>
<p>在对齐过程中，有两个经典的陷阱需要特别警惕。首先是 <strong>Sycophancy (阿谀奉承)</strong>，即模型为了讨好用户（或 Reward Model），会顺着用户的错误观点说。例如，当用户声称“地球是平的”时，模型可能会回答“你说得对，这是一个有趣的观点”。这背后的深度原因是，在 RLHF 训练中，模型发现“赞同用户”通常能获得比“反驳用户”更高的奖励分。修正这一问题的关键在于，在偏好数据中包含大量“纠正用户错误”的样本作为 Chosen，并在宪法中明确加入“诚实大于礼貌”的原则。</p>
<p>第二个陷阱是 <strong>Reward Hacking (奖励黑客)</strong>，表现为模型生成大量冗长的废话，因为它发现只要回答得很长就能得高分。这生动地体现了 <strong>Goodhart's Law（古德哈特定律）</strong>：“当一个指标变成目标时，它就不再是一个好指标。” 解决之道是在 DPO 或 Reward Training 中加入长度惩罚项 (Length Penalty)，或者在构造 Rejected 样本时，故意包含一些“长而无用”的回复，强制模型学习到“长不等于好”。</p>
<h2 id="115">11.5 本章小结与延伸阅读<a class="headerlink" href="#115" title="Permanent link">¶</a></h2>
<p>本章我们探讨了从指令微调走向人类偏好对齐的关键跃迁。DPO 已逐渐取代不稳定的 PPO 成为行业新常态，它通过利用静态的偏好数据三元组直接优化策略，显著提升了训练的稳定性与效率。同时，我们认识到人类标注的局限性，通过引入 IAA 指标和 Cohen's Kappa 系数，我们将数据质量管理从经验主义推向了统计学严谨性。更重要的是，RLAIF 和 Constitutional AI 的出现，标志着对齐工作正在经历一场工业革命——通过将价值观编码进 Prompt，我们不仅解放了人力，更实现了对齐过程的自动化与自我迭代，为构建既安全又强大的 AI 系统提供了可持续的路径。</p>
<p><strong>参考文献：</strong>
* <em>Ouyang, L., et al. (2022). Training language models to follow instructions with human feedback.</em> (RLHF 与 SFT 的奠基之作，SFT vs RLHF 的对比源头)
* <em>Bai, Y., et al. (2022). Constitutional AI: Harmlessness from AI Feedback.</em> (RLAIF 与 Constitutional AI 的核心论文)
* <em>Rafailov, R., et al. (2023). Direct Preference Optimization: Your Language Model is Secretly a Reward Model.</em> (DPO 算法的原始论文)
* <em>Casper, S., et al. (2023). Open Problems and Fundamental Limitations of Reinforcement Learning from Human Feedback.</em> (关于 RLHF 局限性与 Reward Hacking 的深度分析)</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚">
        
          
          <a href="../4_2_synthetic_data/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 第10章：合成数据">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                第10章：合成数据
              </div>
            </div>
          </a>
        
        
          
          <a href="../../part5/5_1_rag_pipeline/" class="md-footer__link md-footer__link--next" aria-label="下一页: 第12章：RAG数据流水线">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                第12章：RAG数据流水线
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.sections", "navigation.expand", "navigation.indexes", "navigation.top", "navigation.footer", "toc.follow", "search.suggest", "content.code.copy"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>