<!DOCTYPE html><html lang="ja" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="大模型数据工程：架构、算法及项目实战">
      
      
        <meta name="author" content="ustc">
      
      
        <link rel="canonical" href="https://datascale-ai.github.io/data_engineering_book/ja/part3/3_1_image_text_pairs/">
      
      
        <link rel="prev" href="../../part2/2_3_tokenization_serialization/">
      
      
        <link rel="next" href="../3_2_recaptioning/">
      
      
        
          <link rel="alternate" href="../../../part3/3_1_image_text_pairs/" hreflang="zh">
        
          <link rel="alternate" href="../../../en/part3/3_1_image_text_pairs/" hreflang="en">
        
          <link rel="alternate" href="./" hreflang="ja">
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>第6章: 画像・テキストペア処理 - 大規模モデルデータエンジニアリング: アーキテクチャ・アルゴリズム・実践プロジェクト</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#6" class="md-skip">
          コンテンツにスキップ
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="ヘッダー">
    <a href="../../" title="大規模モデルデータエンジニアリング: アーキテクチャ・アルゴリズム・実践プロジェクト" class="md-header__button md-logo" aria-label="大規模モデルデータエンジニアリング: アーキテクチャ・アルゴリズム・実践プロジェクト" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            大規模モデルデータエンジニアリング: アーキテクチャ・アルゴリズム・実践プロジェクト
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第6章: 画像・テキストペア処理
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red" aria-label="ダークモードに切り替え" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="ダークモードに切り替え" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="red" aria-label="ライトモードに切り替え" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="ライトモードに切り替え" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="言語切り替え">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"></path></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../../part3/3_1_image_text_pairs/" hreflang="zh" class="md-select__link">
              简体中文
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../../en/part3/3_1_image_text_pairs/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="ja" class="md-select__link">
              日本語
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="検索" placeholder="検索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="検索">
        
        <button type="reset" class="md-search__icon md-icon" title="クリア" aria-label="クリア" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            検索を初期化
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/datascale-ai/data_engineering_book/tree/main" title="リポジトリへ" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="ナビゲーション" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../" title="大規模モデルデータエンジニアリング: アーキテクチャ・アルゴリズム・実践プロジェクト" class="md-nav__button md-logo" aria-label="大規模モデルデータエンジニアリング: アーキテクチャ・アルゴリズム・実践プロジェクト" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    大規模モデルデータエンジニアリング: アーキテクチャ・アルゴリズム・実践プロジェクト
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/datascale-ai/data_engineering_book/tree/main" title="リポジトリへ" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    目次
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第1部: インフラとコアコンセプト
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    第1部: インフラとコアコンセプト
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/1_1_data_change/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第1章: LLM時代のデータ革命
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/1_2_data_infra/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第2章: データインフラ選定
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3">
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第2部: テキスト事前学習データエンジニアリング
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    第2部: テキスト事前学習データエンジニアリング
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/2_1_data_acquisition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第3章: データ取得と収集
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/2_2_cleaning_denoising/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第4章: クリーニングとノイズ除去
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/2_3_tokenization_serialization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第5章: Tokenizationとシリアライズ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第3部: マルチモーダルデータエンジニアリング
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    第3部: マルチモーダルデータエンジニアリング
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    第6章: 画像・テキストペア処理
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    第6章: 画像・テキストペア処理
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目次">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目次
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      
        第 6 章: 画像とテキストのペアのデータ処理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第 6 章: 画像とテキストのペアのデータ処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        章の概要
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#61-laion-5b-obelicsmmc4" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 データ パラダイム: 画像とテキストのペア (LAION-5B) とインターリーブされたドキュメント (OBELICS/MMC4)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.1 データ パラダイム: 画像とテキストのペア (LAION-5B) とインターリーブされたドキュメント (OBELICS/MMC4)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#611" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1.1 中心となる概念と原則
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#612" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1.2 アーキテクチャの決定: 比較表
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 画像の取得と前処理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.2 画像の取得と前処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#621-img2dataset" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2.1 img2dataset の高同時ダウンロードの実際
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#622" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2.2 視覚的な前処理の落とし穴: トリミングとセマンティック アライメント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#623-gpu-nvidia-dali" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2.3 GPU アクセラレーションによるデコードと変換 (NVIDIA DALI)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3 マルチモーダルな洗浄パイプライン
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.3 マルチモーダルな洗浄パイプライン">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#631" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3.1 アーキテクチャ設計: レイ データ分散クリーニング
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#632" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3.2 コアアルゴリズムの実装
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4 落とし穴とトラブルシューティング
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3_2_recaptioning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第7章: Recaptioning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3_3_video_audio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第8章: 動画と音声データ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5">
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第4部: アライメントと合成データエンジニアリング
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    第4部: アライメントと合成データエンジニアリング
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/4_1_sft_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第9章: SFTデータ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/4_2_synthetic_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第10章: 合成データ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/4_3_preference_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第11章: 人間嗜好データ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6">
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第5部: アプリケーション級データエンジニアリング
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    第5部: アプリケーション級データエンジニアリング
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/5_1_rag_pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第12章: RAGデータパイプライン
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/5_2_mm_rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第13章: マルチモーダルRAG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7">
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第6部: 実践プロジェクト集
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    第6部: 実践プロジェクト集
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_1_mini_c4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    プロジェクト1: Mini-C4事前学習セット構築
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_2_legal_sft/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    プロジェクト2: 垂直領域エキスパートSFT
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_3_llava_instruct/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    プロジェクト3: LLaVAマルチモーダル指示セット構築
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_4_synthetic_textbook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    プロジェクト4: 数学/コード教科書合成
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_5_mm_rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    プロジェクト5: マルチモーダルRAG企業財務レポートアシスタント
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目次">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目次
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      
        第 6 章: 画像とテキストのペアのデータ処理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第 6 章: 画像とテキストのペアのデータ処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        章の概要
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#61-laion-5b-obelicsmmc4" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 データ パラダイム: 画像とテキストのペア (LAION-5B) とインターリーブされたドキュメント (OBELICS/MMC4)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.1 データ パラダイム: 画像とテキストのペア (LAION-5B) とインターリーブされたドキュメント (OBELICS/MMC4)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#611" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1.1 中心となる概念と原則
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#612" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1.2 アーキテクチャの決定: 比較表
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 画像の取得と前処理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.2 画像の取得と前処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#621-img2dataset" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2.1 img2dataset の高同時ダウンロードの実際
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#622" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2.2 視覚的な前処理の落とし穴: トリミングとセマンティック アライメント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#623-gpu-nvidia-dali" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2.3 GPU アクセラレーションによるデコードと変換 (NVIDIA DALI)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3 マルチモーダルな洗浄パイプライン
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.3 マルチモーダルな洗浄パイプライン">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#631" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3.1 アーキテクチャ設計: レイ データ分散クリーニング
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#632" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3.2 コアアルゴリズムの実装
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4 落とし穴とトラブルシューティング
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>第6章: 画像・テキストペア処理</h1>

<h2 id="6">第 6 章: 画像とテキストのペアのデータ処理<a class="headerlink" href="#6" title="Permanent link">¶</a></h2>
<h3 id="_1">章の概要<a class="headerlink" href="#_1" title="Permanent link">¶</a></h3>
<p>次世代の基礎モデルを構築する過程において、データ エンジニアリングの焦点は、単なるテキストのクリーニングから、物理世界からの多次元信号のキャプチャ、位置合わせ、再構築へと移りました。言語モデル データ エンジニアリングが「ノイズ除去」に関するものであれば、マルチモーダル データ エンジニアリングは「関連付け」と「調整」に関するものです。 GPT-4V、Gemini、Sora の出現により、単一モダリティ データではもはや世界を理解したいというモデルの欲求を満たすことができないことがわかりました。</p>
<p>この章では、10 億規模のマルチモーダル データセットを構築するための完全なエンジニアリング パイプラインの詳細な分析を提供します。これは、画像をダウンロードするためのいくつかのスクリプトを記述するだけではなく、ネットワーク プロトコル、分散ストレージ、異種コンピューティング、美的評価を含む包括的なキャンペーンです。データ パラダイムの基礎となるロジックを調査し、分散コンピューティング フレームワークを活用して大規模な画像の同時実行性の高い取得の課題を解決する方法を分析し、GPU ハードウェア アクセラレーションを使用して画像前処理の I/O ボトルネックを突破します。さらに、セマンティクスと美学に基づいて自動クリーニング パイプラインを構築し、モデルに入力されるデータの関連性と安全性を確保します。</p>
<p><strong>学習目標</strong>:
* LAION-5B (画像とテキストのペア) および OBELICS (インターリーブ ドキュメント) パラダイムのトレーニングの利点とエンジニアリングの課題を理解し、ハイブリッド データ戦略の設計を習得します。
* PySpark と Ray Data に基づいて分散ダウンローダーを作成し、DNS ボトルネックとロングテール レイテンシーを処理し、10,000 画像/秒以上のスループットを達成できるようになります。
* NVIDIA DALI パイプライン設計をマスターし、CPU デコードのボトルネックを解決し、GPU ダイレクト原理を使用してデータ読み込みを最適化します。
* CLIP セマンティック フィルタリング、審美的スコアリング、安全性検出を含む多段階のクリーニング ファネルを構築し、さまざまなビジネス シナリオに合わせたマスターしきい値調整戦略を構築します。</p>
<p><strong>シナリオの紹介</strong>:</p>
<blockquote>
<p>「次のシナリオを想像してください。私たちのクローラ チームは、Common Crawl から 20 億の生の URL を抽出し、数千の Parquet ファイルに保存しました。あなたの仕事は、このデータを 2 週間以内に GPT-4V の事前トレーニングに適した高品質のデータセットに変換することです。単一マシンで従来の Python リクエスト ライブラリを使用してダウンロードしようとすると、推定時間が 15 年もかかることがわかります。これは典型的なネットワーク I/O ブロック問題です。さらに悪いことに、予備サンプリングでは、ダウンロードされた画像は電子商取引広告 (ノイズだらけ)、15% には重大なウォーターマークが含まれており、重大な NSFW コンテンツさえあります。このデータを直接使用すると、計算に数百万ドルを無駄にするだけでなく、トレーニングされたモデルが不快なコンテンツを生成するために法的リスクに直面する可能性があります。この課題に対処するには、産業グレードの高スループットのインテリジェントなデータ エンジニアリング ソリューションが必要です。」</p>
</blockquote>
<h3 id="61-laion-5b-obelicsmmc4">6.1 データ パラダイム: 画像とテキストのペア (LAION-5B) とインターリーブされたドキュメント (OBELICS/MMC4)<a class="headerlink" href="#61-laion-5b-obelicsmmc4" title="Permanent link">¶</a></h3>
<p>データ パイプラインを設計する前に、私たちの最初の責任はデータの編成形式を明確にすることです。これはストレージ構造だけでなく、トレーニングの目的と下流モデルの創発的な機能も直接決定します。異なるデータ形式は、本質的に、「知識が世界にどのように存在するか」の異なる抽象化です。</p>
<h4 id="611">6.1.1 中心となる概念と原則<a class="headerlink" href="#611" title="Permanent link">¶</a></h4>
<p><strong>画像とテキストのペア</strong>
CLIP、ALIGN、LAION-5B に代表されるマルチモーダル学習の基礎です。
* <strong>理論的分析</strong>: このパラダイムは、画像 <span class="arithmatex">\(I\)</span> とテキスト <span class="arithmatex">\(T\)</span> の間に強い意味的関連性があり、この関連性が独立かつ原子的であることを前提としています。通常、トレーニングの目的は、共有Embedding空間で <span class="arithmatex">\(I\)</span> と <span class="arithmatex">\(T\)</span> のコサイン類似度を最大化することです (対照学習)。その利点は、非常に高い「信号対ノイズ比」の洗練の可能性にあります。モデルは、対照学習を通じて、オブジェクトと語彙の間の直接マッピングを学習します。
* <strong>エンジニアリングの観点</strong>: データ構造は単純で、通常は <code>(url, caption, metadata)</code> のフラット化されたレコードとして表されます。このデータは、シャーディングやランダム シャッフルが非常に簡単です。トレーニング中、サンプルは独立しているため、グローバル バッチ シャッフリングを簡単に実装して、対比学習の効果を向上させることができます。</p>
<p><strong>インターリーブされた画像とテキストのドキュメント</strong>
OBELICSやMMC4に代表される次世代マルチモーダル大型モデル（Flamingo、GPT-4V、MM1など）の鍵となる燃料です。
* <strong>理論分析</strong>: このパラダイムは、<code>&lt;text&gt;, &lt;image&gt;, &lt;text&gt;...</code> のシーケンスとして表示されるデータとともに、Web ページの元の DOM 構造順序を保存します。これにより、モデルは「マルチモーダル コンテキスト依存関係」(マルチモーダル インコンテキスト学習) を学習するようになります。たとえば、「ケーキの作り方」Web ページでは、画像 1 (材料) と画像 5 (完成品) の関係、および周囲のテキストとの論理的接続は、画像とテキストのペアでは提供できません。人間が絵本を読んでいるときの認知プロセスをシミュレートします。
* <strong>エンジニアリングの観点</strong>: データ パイプラインは非常に複雑です。個々のサンプル (ドキュメント) は可変長であり、複数の画像が含まれる場合があるため、バッチの組み立てが困難になります。従来の Collat​​or では、複雑なパディング戦略が必要です。さらに、クリーニング中はドキュメントの整合性を注意深く維持する必要があります。低品質の画像を恣意的に削除すると、コンテキスト ロジックが破損し、モデルが誤った参照関係を学習する可能性があります。</p>
<h4 id="612">6.1.2 アーキテクチャの決定: 比較表<a class="headerlink" href="#612" title="Permanent link">¶</a></h4>
<p>リソースが限られている中で、これら 2 つのデータ パラダイムをどのように比較検討すればよいでしょうか?これは単純な二者択一ではなく、モデル アーキテクチャ、トレーニング コスト、最終的なアプリケーション シナリオ間の深いトレードオフが関係します。</p>
<p>初期のマルチモーダル研究 (2021 年以前) では、データ量が十分である限り (CLIP の場合は 400M ペアなど)、モデルはすべてを学習できると業界は広く信じていました。しかし、GPT-4V の出現により、画像とテキストのペアのみでトレーニングされたモデルは、「これは猫である」を正確に識別できるものの、論理的な推論コンテキストが欠如しているため、「画像内のこの猫が何をするか」には答えることができないことがわかりました。逆に、インターリーブされたドキュメントはロジックが豊富ですが、データがまばらで、処理コストが非常に高くなります。</p>
<p>以下の表は、アーキテクトが実際のニーズに基づいて技術的な選択を行えるようにすることを目的として、エンジニアリング実装レベルでの 2 つのパラダイム間の主な違いを比較しています。</p>
<table>
<thead>
<tr>
<th style="text-align: left;">寸法</th>
<th style="text-align: left;">画像とテキストのペア (LAION スタイル)</th>
<th style="text-align: left;">インターリーブドドキュメント (OBELICS スタイル)</th>
<th style="text-align: left;">徹底した分析と推奨事項</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>トレーニングの目的</strong></td>
<td style="text-align: left;">対照学習 (CLIP)、テキストから画像へ (安定拡散)</td>
<td style="text-align: left;">次のトークンの予測、マルチモーダルダイアログ (GPT-4V)</td>
<td style="text-align: left;"><strong>ハイブリッド戦略は王様です</strong>。研究によると、インターリーブされたドキュメントのみを使用してビジュアル エンコーダをトレーニングするのは非効率的 (画像の密度が十分でない) が、画像とテキストのペアのみを使用すると推論機能が不足することがわかっています。カリキュラム学習戦略を推奨します。</td>
</tr>
<tr>
<td style="text-align: left;"><strong>データ ソースの解析</strong></td>
<td style="text-align: left;">シンプル: <code>&lt;img&gt;</code> タグと代替テキストを抽出するだけです。複雑: DOM ツリーを解析し、広告とサイ​​ドバーをフィルタリングし、メイン コンテンツ ロジックを保持する必要があります。 <strong>エンジニアリングの複雑さに関する警告</strong>。インターリーブされたドキュメントを構築するには、非常に複雑な HTML レンダリング ロジックを処理する必要があります。最初は Common Crawl WET ファイルを使用するか、拡張のために OBELICS オープンソース セットを直接使用することをお勧めします。インターネット全体を最初からクリーンアップしようとしないでください。</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><strong>保管コスト</strong></td>
<td style="text-align: left;">中: メタデータは CSV/Parquet のみで、画像は個別に保存されます。高: ドキュメント トポロジを保存する必要があるため、WebDataset または TFRecord のカプセル化を推奨します。 <strong>I/O パフォーマンスのボトルネック</strong>。インターリーブされたドキュメントの場合は、小さなファイルの断片化を避けるためにシャード ストレージを使用する必要があります。読み取りにはドキュメント全体を事前にロードする必要があり、メモリ帯域幅の要求が高くなります。</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><strong>清掃の課題</strong></td>
<td style="text-align: left;">シングルポイントクリーニング: 各画像は独立して判断され、並列化が容易</td>
<td style="text-align: left;">コンテキストのクリーニング: クリーニング ロジックを組み合わせて、テキストの一貫性と画像の品質を同時に考慮する必要があります。 <strong>戦略の選択</strong>。インターリーブされたドキュメントを処理するときに、画像が NSFW と判断された場合は、位置Embeddingの精度を維持するために、削除するのではなく特別な <code>&lt;BLOCKED_IMAGE&gt;</code> トークンに置き換えることをお勧めします。</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><strong>モデルのメリット</strong></td>
<td style="text-align: left;">強力な視覚的意味論的整合、強力なゼロショット分類</td>
<td style="text-align: left;">強力な少数ショット学習、複数ターンの対話と論理的推論をサポート</td>
<td style="text-align: left;"><strong>ビジネス指向</strong>。シナリオが「画像検索」の場合は、画像とテキストのペアで十分です。複雑な文書の理解 (研究レポートの分析、長編ストーリーの生成など) が含まれる場合は、インターリーブ文書を導入する必要があります。</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>ヒント:</strong>
MM1 や Idefics2 のような最先端の研究では、ベスト プラクティスは二者択一ではなく、比例することです。通常は、<strong>20% インターリーブされたドキュメント</strong>を混合しながら、強固な視覚言語マッピング基盤を確立するために、初期の事前トレーニング段階で <strong>80% の画像とテキストのペア</strong>を使用することをお勧めします。後期の事前トレーニング フェーズ (アニーリング フェーズ) では、インターリーブされたドキュメントの割合を大幅に増やして、モデルのロングコンテキスト推論能力を刺激します。この「基盤が先、ロジックは後」戦略により、コンピューティング使用率が最大化されます。</p>
</blockquote>
<h3 id="62">6.2 画像の取得と前処理<a class="headerlink" href="#62" title="Permanent link">¶</a></h3>
<p>データ マニフェストが決定したら、次のステップは高スループットのダウンロードおよび前処理パイプラインを構築することです。これは典型的な I/O 集中型のタスクであり、ネットワーク帯域幅、DNS 解決の遅延、大量の小さなファイルのディスク書き込みが主なボトルネックとなります。</p>
<h4 id="621-img2dataset">6.2.1 img2dataset の高同時ダウンロードの実際<a class="headerlink" href="#621-img2dataset" title="Permanent link">¶</a></h4>
<p><code>img2dataset</code> は現在、コミュニティで認められたベスト プラクティス ツールです。これは単なるダウンロード スクリプトではなく、MapReduce の原則に基づいた分散データ処理フレームワークです。</p>
<p>単純な <code>requests.get</code> ループを作成する代わりに、特殊なツールが必要なのはなぜですか?インターネット環境が非常に厳しいため。リンクの期限切れ (リンクの破損)、サーバーのレート制限、DNS のタイムアウト。数十億の URL を処理する場合、わずかなロングテールの遅延が数週間の時間コストに増幅されます。</p>
<p><strong>中心原則</strong>:
1. <strong>シャーディング</strong>: 10 億の URL を数万の小さなタスク (シャード) に分割します。これは分散コンピューティングの基礎です。
2. <strong>非同期 I/O</strong>: Python の aiohttp または Go コルーチンを使用して、単一コア上で数百のネットワーク リクエストを同時に開始し、ネットワーク遅延をマスクします。
3. <strong>ストリーミング アーカイブ</strong>: ダウンロードされた画像はディスクに記録されません。これらはメモリ内で tar パッケージ (WebDataset 形式) に直接アセンブルされ、オブジェクト ストレージ (S3/HDFS) にストリーミングされます。これにより、1 つのディレクトリに何百万もの小さなファイルが作成されることによるファイル システムの i ノードの枯渇の問題 (初心者がよく遭遇する落とし穴) が回避されます。</p>
<p><strong>エンジニアリング実装: PySpark 分散ダウンロード スクリプト</strong></p>
<p>PB スケールのデータを処理する場合、単一マシンのマルチ処理モードでは不十分です。 Spark クラスターを使用する必要があります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Recommended environment: PySpark 3_2+, img2dataset 1_41+</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="c1"># Run command: spark-submit --master yarn --deploy-mode cluster...</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">img2dataset</span><span class="w"> </span><span class="kn">import</span> <span class="n">download</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_distributed_download</span><span class="p">():</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    Configuration tuning is key to throughput.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">    process_count: Number of processes per Spark Executor.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    thread_count: Number of async threads per process.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">    For 10Gbps NIC nodes, typically recommend total_concurrency around 1000.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">    """</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="c1"># Define output path (S3 or HDFS)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">output_dir</span> <span class="o">=</span> <span class="s2">"s3a://multimodal-lake/raw-images/laion-5b-subset"</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="c1"># Clean old data (use with caution, production recommends versioning)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span> 
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="c1"># shutil.rmtree(output_dir) # Dangerous operation, commented out</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="k">pass</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="n">download</span><span class="p">(</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="n">processes_count</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>          <span class="c1"># 4 CPU cores per node</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="n">thread_count</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>            <span class="c1"># 64 download threads per core</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="n">url_list</span><span class="o">=</span><span class="s2">"s3a://multimodal-lake/meta/laion-urls.parquet"</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="n">image_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>             <span class="c1"># 256x256 sufficient for pre-training, saves bandwidth</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="n">resize_only_if_bigger</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># Avoid blur from upscaling small images</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="n">resize_mode</span><span class="o">=</span><span class="s2">"keep_ratio"</span><span class="p">,</span>   <span class="c1"># Maintain aspect ratio, black padding or center crop</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="n">skip_reencode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>         <span class="c1"># If original is JPG and size acceptable, store directly, saves CPU</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="n">output_folder</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="n">output_format</span><span class="o">=</span><span class="s2">"webdataset"</span><span class="p">,</span> <span class="c1"># Force WebDataset format</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="n">input_format</span><span class="o">=</span><span class="s2">"parquet"</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="n">url_col</span><span class="o">=</span><span class="s2">"url"</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="n">caption_col</span><span class="o">=</span><span class="s2">"caption"</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="n">enable_wandb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>          <span class="c1"># Strongly recommended for monitoring download rate and error rate</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="n">number_sample_per_shard</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="c1"># 10k images per tar, ~200-300MB, for easy transfer</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="n">distributor</span><span class="o">=</span><span class="s2">"pyspark"</span><span class="p">,</span>      <span class="c1"># Use Spark for task distribution</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="n">save_additional_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"similarity"</span><span class="p">,</span> <span class="s2">"hash"</span><span class="p">],</span> <span class="c1"># Preserve original metadata</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span>                  <span class="c1"># Shorter timeout for fast failure, long-tail requests not worth waiting</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    <span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>    <span class="c1"># Initialize Spark Session (usually handled by spark-submit, but explicit for IDE debugging)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">SparkSession</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>    <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span> \
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">"Img2Dataset-Production"</span><span class="p">)</span> \
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">"spark.executor.memory"</span><span class="p">,</span> <span class="s2">"8g"</span><span class="p">)</span> \
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">"spark.task.maxFailures"</span><span class="p">,</span> <span class="s2">"10"</span><span class="p">)</span> \
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>    <span class="n">run_distributed_download</span><span class="p">()</span>
</code></pre></div>
<p><strong>プロのヒント</strong>:
* <strong>DNS キャッシュ</strong>: 同時実行性が高い場合、DNS 解決がボトルネックになったり、プロバイダーによってブロックされたりする可能性があります。ローカル DNS キャッシュ (例: dnsmasq) をワーカー ノードにデプロイするか、コードでドメインから IP へのマッピング テーブルを維持することをお勧めします。
* <strong>ユーザー エージェントのローテーション</strong>: 「公然の」秘密ではありますが、ユーザー エージェントをローテーションすると 403 Forbidden の割合を減らすことができます。
* <strong>エラー処理</strong>: WandB ダッシュボードで success_rate を監視します。 80% を下回る場合は、通常、URL リストが著しく古いか、IP プールが汚染されていることを意味します。</p>
<h4 id="622">6.2.2 視覚的な前処理の落とし穴: トリミングとセマンティック アライメント<a class="headerlink" href="#622" title="Permanent link">¶</a></h4>
<p>大量のデータの取得 (バイトの取得) という課題を解決した後、すぐに 2 番目の課題、データの使いやすさに直面します。生のインターネット画像のアスペクト比は大きく異なりますが、モデルでは通常、固定解像度の入力 (例: 224x224 または 512x512) が必要です。</p>
<p>初心者向けのエンジニアリング ソリューションの多くは、ディメンションを統一するために単純な総当たりランダム前処理を習慣的に使用していますが、これがモデルの「目に見えないパフォーマンスの上限」の根本であることがよくあります。 「イメージをはめ込む」だけではなく、「何が込められているのか」にも注力しなければなりません。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../images/part3/%E5%9B%BE6_1_%E5%9B%BE%E7%89%87%E9%A2%84%E5%A4%84%E7%90%86%E4%B8%AD%E8%A3%81%E5%89%AA%E4%B8%8E%E8%AF%AD%E4%B9%89%E5%AF%B9%E9%BD%90%E9%97%AE%E9%A2%98.png" data-desc-position="bottom"><img alt="図 6-1: 画像前処理におけるトリミングとセマンティック調整" src="../../../images/part3/%E5%9B%BE6_1_%E5%9B%BE%E7%89%87%E9%A2%84%E5%A4%84%E7%90%86%E4%B8%AD%E8%A3%81%E5%89%AA%E4%B8%8E%E8%AF%AD%E4%B9%89%E5%AF%B9%E9%BD%90%E9%97%AE%E9%A2%98.png"></a>
<em>図 6-1: 画像の前処理におけるトリミングとセマンティック アライメント</em></p>
<ul>
<li>
<p><strong>悪いケース (左の画像 - 単純なトリミングのコスト)</strong>:
    従来の <code>RandomCrop</code> または <code>CenterCrop</code> は構成を意識しません。縦方向の構図でポートレート写真を処理する場合、中央のトリミングにより重要な部分 (頭など) が簡単に切り取られ、胴体だけが残ります。この時点で、テキスト ラベルがまだ「笑顔の人」である場合、モデルは間違ったマッピング (胴体の特徴を「笑顔の人」と誤認) を確立することを強制され、トレーニングされたモデルが重度の幻覚を引き起こす原因になります。</p>
</li>
<li>
<p><strong>良いケース (右の画像 - セマンティックな完全性)</strong>:
    「画像とテキストの一貫性」を追求した高品質なデータエンジニアリング。</p>
<ol>
<li><strong>スマート サイズ変更</strong>: 完全な視覚的主題を維持するには、<code>Resize with Padding</code> (アスペクト比、黒/白のパディングを維持) を優先します。これにより無効なピクセルが発生しますが、セマンティックな完全性が保証されます。</li>
<li><strong>アスペクト比バケット</strong>: SDXL と Midjourney で一般的に使用される高度な技術。同様のアスペクト比を持つ画像をトレーニング用に同じバッチにグループ化し、パディングの無駄を減らしながらトリミングを回避します。</li>
<li><strong>要約</strong>: 以下の第 7 章で詳しく説明されているように、VLM を使用して高密度の説明を生成すると、テキストが画面上の詳細 (標識テキスト、背景オブジェクトなど) に正確に対応し、データ トレーニングの価値が最大化されます。</li>
</ol>
</li>
</ul>
<h4 id="623-gpu-nvidia-dali">6.2.3 GPU アクセラレーションによるデコードと変換 (NVIDIA DALI)<a class="headerlink" href="#623-gpu-nvidia-dali" title="Permanent link">¶</a></h4>
<p>ディープ ラーニング モデルのトレーニング フェーズでは、ほとんどの研究者や開発者がモデル アーキテクチャの設計、ハイパーパラメータの調整、損失関数の改善 (モデルの精度に直接影響するモジュール) に注目しますが、データ ロード (DataLoader) の基礎を見落としがちです。実際には、これがトレーニング効率を制限する「目に見えないパフォーマンスキラー」となることが多く、ハイエンド GPU コンピューティングの完全な利用を妨げ、深刻なハードウェアの無駄を引き起こすことさえあります。</p>
<p>この問題点を理解するには、まず深層学習トレーニング フローの完全なロジックを明確にする必要があります。モデル トレーニングのコア コンピューティングは、GPU の大規模な並列コンピューティング機能に依存しています。 GPU は大規模なテンソル演算を効率的に処理し、バックプロパゲーションとパラメーターの更新を完了できます。ただし、データが GPU に入力される前に、一連の前処理操作を通過する必要があります。その中で最も基本的で時間のかかる操作は、画像のデコードとサイズ変更です。従来の PyTorch トレーニング フローでは、これらの重要な前処理操作はすべて CPU 上で実行され、「CPU 前処理のボトルネック」と「GPU 計算の冗長性」の間に矛盾が生じます。</p>
<p>具体的には、従来の PyTorch Dataset ワークフローは次のとおりです。まず、CPU を介してディスクから画像ファイル (主に JPEG) を読み取り、次に CPU が JPEG デコードを完了します。このプロセスには、圧縮画像バイナリ データに対するハフマン デコード、逆離散コサイン変換 (IDCT) およびその他の複雑な計算が必要であり、一般的な CPU 負荷の高いタスクです。デコード後、CPU はサイズ変更、正規化、色空間変換などの前処理を実行し、最終的に処理された画像テンソルをモデルのトレーニングのために GPU にコピーします。</p>
<p>さらに重要なのは、CPU アーキテクチャがシリアル計算とロジック制御により適していることです。並列計算能力は GPU よりもはるかに劣ります。それでも、デコードやサイズ変更などの画像前処理操作は本質的に高度に並列化可能であり、マルチスレッドまたはマルチコア並列処理によって効率を向上させることができます。しかし、従来の PyTorch データセットは、CPU 並列処理を向上させる DataLoader の num_workers を使用したとしても、CPU 自体のコンピューティングの上限を突破することはほとんどできません。特に、トレーニング データセットが大規模 (数百万の画像) で、単一画像の解像度が高い (1080p+) 場合、CPU の前処理速度が GPU トレーニング速度に大幅に遅れ、GPU が頻繁に「データ待ち」でアイドル状態になり、GPU 使用率が大幅に低下し、最終的に全体のトレーニング効率が低下します。これが、データの読み込みが「無視されたパフォーマンスキラー」と呼ばれる理由です。</p>
<p>この中心的な問題点に対処するために、NVIDIA は、ディープ ラーニング トレーニング用に最適化された GPU アクセラレーションのデータ前処理ライブラリである DALI (Data Loading Library) を導入しました。その中心的な目標は、画像のデコードやサイズ変更などの CPU を集中的に使用する操作を GPU に移行して並列実行し、データ読み込みパフォーマンスのボトルネックを解消し、GPU を最大限に活用できるようにすることです。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../images/part3/%E5%9B%BE6_2_%E4%BD%BF%E7%94%A8DALI%E4%B8%8E%E4%B8%8D%E4%BD%BF%E7%94%A8DALI%E4%B8%8B%E6%95%B0%E6%8D%AE%E8%A7%A3%E7%A0%81%E4%B8%8E%E5%8F%98%E6%8D%A2%E7%9A%84%E5%8C%BA%E5%88%AB.png" data-desc-position="bottom"><img alt="図 6-2: DALI を使用した場合と使用しない場合のデータのデコードと変換" src="../../../images/part3/%E5%9B%BE6_2_%E4%BD%BF%E7%94%A8DALI%E4%B8%8E%E4%B8%8D%E4%BD%BF%E7%94%A8DALI%E4%B8%8B%E6%95%B0%E6%8D%AE%E8%A7%A3%E7%A0%81%E4%B8%8E%E5%8F%98%E6%8D%A2%E7%9A%84%E5%8C%BA%E5%88%AB.png"></a>
<em>図 6-2: DALI を使用した場合と使用しない場合のデータのデコードと変換</em></p>
<p><strong>コードのチュートリアル: 高性能 DALI パイプライン</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">nvidia.dali.fn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">fn</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">nvidia.dali.types</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">types</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">nvidia.dali.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">pipeline_def</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="nd">@pipeline_def</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">device_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">webdataset_gpu_pipeline</span><span class="p">(</span><span class="n">shard_id</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">):</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="sd">    Define end-to-end GPU data loading pipeline</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="sd">    Input: WebDataset (Tar) -&gt; Output: GPU Tensor</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="sd">    """</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    <span class="c1"># Step 1: Read WebDataset (CPU stage)</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>    <span class="c1"># Using index_paths is necessary, otherwise initialization requires traversing entire tar, extremely slow [5]</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>    <span class="n">jpegs</span><span class="p">,</span> <span class="n">captions</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">readers</span><span class="o">.</span><span class="n">webdataset</span><span class="p">(</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>        <span class="n">paths</span><span class="o">=</span><span class="p">[</span><span class="s2">"/data/shards/shard-</span><span class="si">{:05d}</span><span class="s2">.tar"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)],</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>        <span class="n">index_paths</span><span class="o">=</span><span class="p">[</span><span class="s2">"/data/indices/shard-</span><span class="si">{:05d}</span><span class="s2">.idx"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)],</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>        <span class="n">ext</span><span class="o">=</span><span class="p">[</span><span class="s2">"jpg"</span><span class="p">,</span> <span class="s2">"txt"</span><span class="p">],</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>        <span class="n">shard_id</span><span class="o">=</span><span class="n">shard_id</span><span class="p">,</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>        <span class="n">num_shards</span><span class="o">=</span><span class="n">num_shards</span><span class="p">,</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>        <span class="n">random_shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>        <span class="n">initial_fill</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>      <span class="c1"># Shuffle buffer size, larger = more random but slower startup</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>        <span class="n">pad_last_batch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>     <span class="c1"># Ensure all batches have consistent size</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">"Reader"</span><span class="p">,</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>        <span class="n">read_ahead</span><span class="o">=</span><span class="kc">True</span>          <span class="c1"># Enable read-ahead</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>    <span class="p">)</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>    <span class="c1"># Step 2: GPU Decoding (core acceleration point)</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>    <span class="c1"># device="mixed" means input in Host memory, output in Device memory</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>    <span class="c1"># output_type=types.RGB handles color space conversion automatically</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>    <span class="n">images</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">decoders</span><span class="o">.</span><span class="n">image</span><span class="p">(</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>        <span class="n">jpegs</span><span class="p">,</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>        <span class="n">device</span><span class="o">=</span><span class="s2">"mixed"</span><span class="p">,</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>        <span class="n">output_type</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">RGB</span><span class="p">,</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>        <span class="c1"># Error handling for corrupted images</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>        <span class="c1"># In production, never let a single bad image crash training</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>    <span class="p">)</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>    <span class="c1"># Step 3: GPU transformation pipeline</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>    <span class="c1"># resize: maintain aspect ratio scaling</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a>    <span class="n">images</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a>        <span class="n">images</span><span class="p">,</span>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>        <span class="n">resize_x</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a>        <span class="n">resize_y</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>        <span class="n">interp_type</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">INTERP_LINEAR</span>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>    <span class="p">)</span>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>    <span class="c1"># crop_mirror_normalize: random crop + flip + normalize (fused operator)</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>    <span class="c1"># This step converts uint8 to float and subtracts mean, divides by std</span>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>    <span class="n">images</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">crop_mirror_normalize</span><span class="p">(</span>
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a>        <span class="n">images</span><span class="p">,</span>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>        <span class="n">dtype</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>        <span class="n">output_layout</span><span class="o">=</span><span class="s2">"CHW"</span><span class="p">,</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>        <span class="n">crop</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span>
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>        <span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mi">0_485</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0_456</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0_406</span> <span class="o">*</span> <span class="mi">255</span><span class="p">],</span>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a>        <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mi">0_229</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0_224</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0_225</span> <span class="o">*</span> <span class="mi">255</span><span class="p">],</span>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>        <span class="n">mirror</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">coin_flip</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="mi">0_5</span><span class="p">)</span>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>    <span class="p">)</span>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a>    <span class="c1"># Text data typically processed directly on CPU or passed to Tokenizer</span>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a>    <span class="c1"># Here we only return raw bytes for subsequent PyTorch processing</span>
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a>    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">captions</span>
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a>
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a><span class="c1"># Use DALIGenericIterator integrated with PyTorch</span>
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a><span class="kn">from</span><span class="w"> </span><span class="nn">nvidia.dali.plugin.pytorch</span><span class="w"> </span><span class="kn">import</span> <span class="n">DALIGenericIterator</span>
<a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a>
<a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a><span class="n">pipe</span> <span class="o">=</span> <span class="n">webdataset_gpu_pipeline</span><span class="p">(</span><span class="n">shard_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_shards</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a><span class="n">pipe</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
<a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a><span class="n">dataloader</span> <span class="o">=</span> <span class="n">DALIGenericIterator</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="p">[</span><span class="s2">"images"</span><span class="p">,</span> <span class="s2">"captions"</span><span class="p">],</span> <span class="n">reader_name</span><span class="o">=</span><span class="s2">"Reader"</span><span class="p">)</span>
<a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a>
<a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a><span class="c1"># Benchmark test</span>
<a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a><span class="c1"># On A100, this pipeline typically achieves 3000-5000 FPS, 5-10x CPU Loader</span>
</code></pre></div>
<h3 id="63">6.3 マルチモーダルな洗浄パイプライン<a class="headerlink" href="#63" title="Permanent link">¶</a></h3>
<p>大量のデータには大量のノイズが伴います。 LAION-5B の生データでは、真に高品質のサンプルは 10% 未満である可能性があります。データの多様性の損失を最小限に抑えながらデータ密度を向上させるには、多段階のクリーニング ファネルを確立する必要があります。いわゆる「データ クリーニング」は本質的に <strong>データ ダイエット</strong> であり、モデルへのフィードの量を減らし、より良くすることです。</p>
<h4 id="631">6.3.1 アーキテクチャ設計: レイ データ分散クリーニング<a class="headerlink" href="#631" title="Permanent link">¶</a></h4>
<p>クリーニングフェーズにスパークではなくレイを選択する理由は何ですか?なぜなら、クリーニングにはもはや単純な ETL ではなく、大量の <strong>深層学習推論 (モデル推論)</strong> が含まれているからです。 Spark の MapReduce パラダイムと比較して、Ray はより柔軟な Actor メカニズムを提供し、GPU モデル (CLIP、Safety Checker など) を常駐させ、小さなバッチごとに複数 GB のモデルをリロードするという膨大なオーバーヘッドを回避できます。</p>
<p>Ray Data は、CPU 集中型 (解凍、ハッシュ、正規表現) タスクと GPU 集中型 (CLIP Embedding推論) タスクの両方を伴うこの混合ワークロードに適しています。以下は、一般的な 3 段階のパイプライン設計です。
* <strong>ステージ 1 (CPU)</strong>: 高速フィルタリング。解像度が不十分 (&lt;256px)、テキストが短すぎる、英語以外 (英語モデルのみをトレーニングしている場合)、または異常なアスペクト比を持つサンプルを直接削除します。
* <strong>ステージ 2 (GPU)</strong>: 詳細な特徴抽出。 CLIP モデルを使用してエンベディングを生成し、エンベディングに基づいて画像とテキストの類似性と美的スコアを計算します。
* <strong>ステージ 3 (CPU/混合)</strong>: ロジックの評価と重複排除。安全性 (NSFW)、美的スコア、画像とテキストの関連性に基づいて最終しきい値カットオフを適用し、セマンティックな重複排除を実行します。</p>
<p><strong>データ フロー図</strong></p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../images/part3/%E5%9B%BE6_3_Ray_Data%E5%88%86%E5%B8%83%E5%BC%8F%E6%B8%85%E6%B4%97%E6%95%B0%E6%8D%AE%E6%B5%81%E5%90%91%E5%9B%BE.png" data-desc-position="bottom"><img alt="図 6-3: Ray Data 分散型洗浄データの流れ" src="../../../images/part3/%E5%9B%BE6_3_Ray_Data%E5%88%86%E5%B8%83%E5%BC%8F%E6%B8%85%E6%B4%97%E6%95%B0%E6%8D%AE%E6%B5%81%E5%90%91%E5%9B%BE.png"></a>
<em>図 6-3: Ray データ分散クリーニング データ フロー</em></p>
<h4 id="632">6.3.2 コアアルゴリズムの実装<a class="headerlink" href="#632" title="Permanent link">¶</a></h4>
<p>クリーニングは単なる削除ではなく、データ値の量子化でもあります。画像とそれに対応するテキストの「ゴールド コンテンツ」を測定するには、多次元のメトリクスが必要です。</p>
<ol>
<li>
<p><strong>美的スコア</strong></p>
<ul>
<li><strong>原則</strong>: データセットは請求書、スクリーンショット、不鮮明な監視映像でいっぱいです。これらは美しい画像を生成するのには役に立ちません。通常は LAION-Aesthetics Predictor を使用します。</li>
<li><strong>技術詳細</strong>: CLIP 画像Embeddingを入力として使用し、1 ～ 10 のスコアを出力する単純な MLP (多層パーセプトロン)。 AVA データセットからのトレーニング データ (プロの写真家の人間による評価)。</li>
<li><strong>推奨しきい値</strong>: 基本的な事前トレーニングでは、スコア &gt; 4_5 を維持します。高品質の生成モデル (SFT ステージ) を微調整するには、スコア &gt; 6_0、または 6_5 を推奨します。</li>
</ul>
</li>
<li>
<p><strong>画像とテキストの配置フィルタリング</strong></p>
<ul>
<li><strong>原則</strong>: 代替テキストの多くは、画像コンテンツとは関係のない、SEO のゴミ単語の積み重ねやファイル名 (「DSC_001.jpg」) です。</li>
<li><strong>技術詳細</strong>: CLIP 画像EmbeddingとテキストEmbeddingのコサイン類似度 (ドット積) を計算します。</li>
<li><strong>落とし穴</strong>: CLIP のバージョンが異なると (例: OpenAI ViT-L/14 と OpenCLIP ViT-G/14)、エンベディング スペースの分布が異なります。スコアは直接比較できません。特定のモデルのしきい値を再調整する必要があります。一般的なアプローチ: データセット全体の類似度分布を計算し、上位 50% または上位 70% を維持します。</li>
</ul>
</li>
<li>
<p><strong>安全性の検出 (安全性とウォーターマーク)</strong></p>
<ul>
<li><strong>原則</strong>: ポルノ、暴力、目立つ透かし入りの画像は削除する必要があります。</li>
<li><strong>戦略</strong>: NSFW とウォーターマークの検出には、特別にトレーニングされた分類子ヘッド (CLIP Embeddingにも基づく) を使用します。ウォーターマーク検出の場合: ターゲットが生成モデル (SDXL など) をトレーニングしている場合、生成モデルはウォーターマーク特徴に簡単にオーバーフィットするため、非常に厳密 (リコール優先) である必要があります。ターゲットが理解モデル (GPT-4V など) をトレーニングしている場合、理解モデルは「画像に透かしがある」ことを認識する必要があるため、多少緩和できます。</li>
</ul>
</li>
</ol>
<p><strong>コード実装: Ray Data Cleaning Operator</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">ray</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">open_clip</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="c1"># Define Ray Actor class to ensure model loaded only once</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">QualityScorer</span><span class="p">:</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>        <span class="c1"># Load CLIP model (ViT-B-32 fast, suitable for cleaning)</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">=</span> <span class="n">open_clip</span><span class="o">.</span><span class="n">create_model_and_transforms</span><span class="p">(</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>            <span class="s1">'ViT-B-32'</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="s1">'laion2b_s34b_b79k'</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>        <span class="p">)</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="c1"># Load aesthetic scoring head (Linear Layer)</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aesthetic_head</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aesthetic_head</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"sac+logos+ava1-l14-linearMSE.pth"</span><span class="p">))</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aesthetic_head</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="sd">        Process a batch of data. Ray will automatically partition and transfer data to Actor.</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="sd">        """</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>        <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>        <span class="c1"># Preprocess images (CPU operation)</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">img_bytes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">"jpg"</span><span class="p">]):</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img_bytes</span><span class="p">))</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">"RGB"</span><span class="p">)</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>                <span class="n">img_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>                <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">)</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>                <span class="n">valid_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>                <span class="c1"># Log bad image but don't interrupt</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>                <span class="k">continue</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">images</span><span class="p">:</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">"aesthetic_score"</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">"clip_score"</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>        <span class="n">image_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>            <span class="c1"># 1. Extract features</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>            <span class="n">image_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encode_image</span><span class="p">(</span><span class="n">image_input</span><span class="p">)</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>            <span class="n">image_features</span> <span class="o">/=</span> <span class="n">image_features</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>            <span class="c1"># 2. Compute aesthetic score</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>            <span class="n">aesthetic_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aesthetic_head</span><span class="p">(</span><span class="n">image_features</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>            <span class="c1"># 3. Compute image-text match (assuming batch has text field)</span>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>            <span class="c1"># text_tokens = self.tokenizer(batch["txt"]).to(self.device)</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>            <span class="c1"># text_features = self.model.encode_text(text_tokens)</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>            <span class="c1">#... compute cosine similarity</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>        <span class="c1"># Return results (must align with original batch indices)</span>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">"aesthetic_score"</span><span class="p">:</span> <span class="n">aesthetic_scores</span><span class="p">}</span>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a><span class="c1"># Orchestrate Ray pipeline</span>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a><span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a><span class="n">ds</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">read_webdataset</span><span class="p">(</span><span class="s2">"s3://raw-bucket/{00000..00099}.tar"</span><span class="p">)</span>
<a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a>
<a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a><span class="c1"># map_batches will automatically schedule GPU resources</span>
<a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a><span class="c1"># num_gpus=0_25 means one GPU can run 4 Actors concurrently, improving throughput</span>
<a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a><span class="n">scored_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span>
<a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a>    <span class="n">QualityScorer</span><span class="p">,</span> 
<a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a>    <span class="n">compute</span><span class="o">=</span><span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ActorPoolStrategy</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> 
<a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a>    <span class="n">num_gpus</span><span class="o">=</span><span class="mi">0_25</span><span class="p">,</span> 
<a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a>    <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span>
<a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a><span class="p">)</span>
<a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a>
<a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a><span class="c1"># Final filtering</span>
<a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a><span class="n">filtered_ds</span> <span class="o">=</span> <span class="n">scored_ds</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">"aesthetic_score"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">4_5</span><span class="p">)</span>
<a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a><span class="n">filtered_ds</span><span class="o">.</span><span class="n">write_webdataset</span><span class="p">(</span><span class="s2">"s3://clean-bucket/"</span><span class="p">)</span>
</code></pre></div>
<h3 id="64">6.4 落とし穴とトラブルシューティング<a class="headerlink" href="#64" title="Permanent link">¶</a></h3>
<p>数十億規模のマルチモーダル データセットを構築する際、エンジニアリング チームは詳細でつまずくことがよくあります。ここでは、いくつかの教訓を学びました。</p>
<ul>
<li>
<p><strong>寄木細工のメタデータの爆発的増加</strong>:</p>
<ul>
<li><strong>エラー</strong>: パンダで 20 億行の Parquet ファイルを直接読み取る習慣があります。</li>
<li><strong>結果</strong>: メモリ オーバーフロー (OOM)。パンダは 1 列だけを読み取る場合でもインデックス全体をメモリに読み込もうとするためです。</li>
<li><strong>修正</strong>: Polars または PySpark 遅延評価モードを使用します。または、単一の巨大なメタデータ ファイルの処理を避けるために、Parquet ファイルを行数 (例: 100 万行) ごとに小さなファイルに厳密に分割します。</li>
</ul>
</li>
<li>
<p><strong>WebDataset のシャッフルが不十分です</strong>:</p>
<ul>
<li><strong>エラー</strong>: データはダウンロード中にドメイン順序で書き込まれます。トレーニングは DataLoader バッファー シャッフルのみに依存します (通常、バッファーは 10k のみ)。</li>
<li><strong>結果</strong>: モデルは 100,000 個の e-コマース画像を連続して表示し、次に 100,000 個の風景画像を連続して表示する可能性があります。バッファーが小さいと、この「時間的相関」を打ち破ることができず、トレーニング カーブの激しい振動や発散さえも引き起こします。</li>
<li><strong>修正</strong>: WebDataset を書き込む前に、URL リストに対して <strong>グローバル シャッフル</strong> を実行する必要があります。 Spark の <code>orderBy(rand())</code> を使用できます。</li>
</ul>
</li>
<li>
<p><strong>ロングテール データを誤って削除してしまう</strong>:</p>
<ul>
<li><strong>エラー</strong>: 究極の美的スコアを追求するため、スコア &lt; 4_5 の画像をすべて削除します。</li>
<li><strong>結果</strong>: モデルは「特殊化」され、アート写真と壁紙のみを認識し、医療画像、ストリート ビュー、手書きのメモなどの現実世界の (おそらく醜い) 写真は認識しません。モデルの一般化を大幅に軽減します。</li>
<li><strong>修正</strong>: 層別サンプリング戦略を使用します。 5% ～ 10% の低スコア データを「正規化」として保持するか、美的フィルターをバイパスする特定のドメイン (OCR、グラフなど) に特別なホワイトリストを設定します。</li>
</ul>
</li>
<li>
<p><strong>重複データの危険性 (重複排除)</strong>:</p>
<ul>
<li><strong>エラー</strong>: インターネット上の大量の重複画像 (ミーム、バイラル ニュース画像など) を無視します。</li>
<li><strong>結果</strong>: モデルは特定のサンプルをオーバーフィットし、生成中にトレーニング セットの画像を「記憶」することもあり、重大な著作権リスクを引き起こします。</li>
<li><strong>修正</strong>: クリーニング パイプラインに <strong>セマンティック重複排除</strong> を追加する必要があります。すべての画像のEmbeddingを計算し、クラスタリングに Faiss または MinHashLSH を使用し、類似性の高い画像グループごとに 1 つだけ保持します。</li>
</ul>
</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  ページトップへ戻る
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="フッター">
        
          
          <a href="../../part2/2_3_tokenization_serialization/" class="md-footer__link md-footer__link--prev" aria-label="前: 第5章: Tokenizationとシリアライズ">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                前
              </span>
              <div class="md-ellipsis">
                第5章: Tokenizationとシリアライズ
              </div>
            </div>
          </a>
        
        
          
          <a href="../3_2_recaptioning/" class="md-footer__link md-footer__link--next" aria-label="次: 第7章: Recaptioning">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                次
              </span>
              <div class="md-ellipsis">
                第7章: Recaptioning
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.sections", "navigation.expand", "navigation.indexes", "navigation.top", "navigation.footer", "toc.follow", "search.suggest", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f", "clipboard.copy": "\u30af\u30ea\u30c3\u30d7\u30dc\u30fc\u30c9\u3078\u30b3\u30d4\u30fc", "search.result.more.one": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3082\u30461\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.more.other": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3042\u3068#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.none": "\u4f55\u3082\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f", "search.result.one": "1\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.other": "#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.placeholder": "\u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044", "search.result.term.missing": "\u691c\u7d22\u306b\u542b\u307e\u308c\u306a\u3044", "select.version": "\u30d0\u30fc\u30b8\u30e7\u30f3\u5207\u308a\u66ff\u3048"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>