<!DOCTYPE html><html lang="zh" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="大模型数据工程：架构、算法及项目实战">
      
      
        <meta name="author" content="ustc">
      
      
        <link rel="canonical" href="https://datascale-ai.github.io/data_engineering_book/part3/3_2_recaptioning/">
      
      
        <link rel="prev" href="../3_1_image_text_pairs/">
      
      
        <link rel="next" href="../3_3_video_audio/">
      
      
        
          <link rel="alternate" href="./" hreflang="zh">
        
          <link rel="alternate" href="../../en/part3/3_2_recaptioning/" hreflang="en">
        
          <link rel="alternate" href="../../ja/part3/3_2_recaptioning/" hreflang="ja">
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>第7章：数据重描述 - 大模型数据工程：架构、算法及项目实战</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#7-recaptioning" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="大模型数据工程：架构、算法及项目实战" class="md-header__button md-logo" aria-label="大模型数据工程：架构、算法及项目实战" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            大模型数据工程：架构、算法及项目实战
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第7章：数据重描述
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red" aria-label="切换至夜间模式" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换至夜间模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="red" aria-label="切换至日间模式" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换至日间模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="选择当前语言">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"></path></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="./" hreflang="zh" class="md-select__link">
              简体中文
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../en/part3/3_2_recaptioning/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../ja/part3/3_2_recaptioning/" hreflang="ja" class="md-select__link">
              日本語
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/datascale-ai/data_engineering_book/tree/main" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="大模型数据工程：架构、算法及项目实战" class="md-nav__button md-logo" aria-label="大模型数据工程：架构、算法及项目实战" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    大模型数据工程：架构、算法及项目实战
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/datascale-ai/data_engineering_book/tree/main" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    目录
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第一部分：基础设施与核心理念
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    第一部分：基础设施与核心理念
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/1_1_data_change/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第1章：大模型时代的数据变革
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/1_2_data_infra/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第2章：数据基础设施选型
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3">
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第二部分：文本预训练数据工程
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    第二部分：文本预训练数据工程
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/2_1_data_acquisition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第3章：数据获取与采集
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/2_2_cleaning_denoising/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第4章：清洗与去噪
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/2_3_tokenization_serialization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第5章：分词与序列化
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第三部分：多模态数据工程
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    第三部分：多模态数据工程
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3_1_image_text_pairs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第6章：图文对数据处理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    第7章：数据重描述
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    第7章：数据重描述
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#7-recaptioning" class="md-nav__link">
    <span class="md-ellipsis">
      
        第7章：数据重描述 (Recaptioning)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第7章：数据重描述 (Recaptioning)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        本章摘要
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#71-alt-text" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 Alt-text 的局限性：为什么原始网页描述不可用？
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-vlm" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 合成描述工厂：利用 VLM 重生数据
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.2 合成描述工厂：利用 VLM 重生数据">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#721" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2.1 模型选型与架构
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#722-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2.2 Prompt 策略：控制颗粒度
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#723-vllm" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2.3 工程实现：使用 vLLM 构建高吞吐推理服务
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-ocr" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3 OCR 增强：提取图中文字并融合
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.3 OCR 增强：提取图中文字并融合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#731-ocr" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3.1 OCR 增强流水线
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#732-ocr" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3.2 核心代码：OCR 结果注入
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3_3_video_audio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第8章：视频与音频数据
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5">
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第四部分：对齐与合成数据工程
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    第四部分：对齐与合成数据工程
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/4_1_sft_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第9章：指令微调数据
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/4_2_synthetic_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第10章：合成数据
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/4_3_preference_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第11章：人类偏好数据
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6">
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第五部分：应用级数据工程
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    第五部分：应用级数据工程
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/5_1_rag_pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第12章：RAG数据流水线
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/5_2_mm_rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第13章：多模态RAG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7">
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    第六部分：实战项目集
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    第六部分：实战项目集
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_1_mini_c4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    项目一：构建Mini-C4预训练集
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_2_legal_sft/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    项目二：垂直领域专家SFT
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_3_llava_instruct/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    项目三：构建LLaVA多模态指令集
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_4_synthetic_textbook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    项目四：合成数学代码教科书
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_5_mm_rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    项目五：多模态RAG企业财报助手
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#7-recaptioning" class="md-nav__link">
    <span class="md-ellipsis">
      
        第7章：数据重描述 (Recaptioning)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第7章：数据重描述 (Recaptioning)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        本章摘要
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#71-alt-text" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 Alt-text 的局限性：为什么原始网页描述不可用？
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-vlm" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 合成描述工厂：利用 VLM 重生数据
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.2 合成描述工厂：利用 VLM 重生数据">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#721" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2.1 模型选型与架构
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#722-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2.2 Prompt 策略：控制颗粒度
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#723-vllm" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2.3 工程实现：使用 vLLM 构建高吞吐推理服务
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-ocr" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3 OCR 增强：提取图中文字并融合
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.3 OCR 增强：提取图中文字并融合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#731-ocr" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3.1 OCR 增强流水线
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#732-ocr" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3.2 核心代码：OCR 结果注入
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>第7章：数据重描述</h1>

<h2 id="7-recaptioning">第7章：数据重描述 (Recaptioning)<a class="headerlink" href="#7-recaptioning" title="Permanent link">¶</a></h2>
<h3 id="_1">本章摘要<a class="headerlink" href="#_1" title="Permanent link">¶</a></h3>
<p>互联网上的原始 Alt-text（替代文本），本质上是网页开发者为搜索引擎优化（SEO）设计的辅助内容，其核心目标是提升网页在搜索结果中的排名，而非精准、全面地描述图像本身的视觉内容——这就导致大量原始 Alt-text 无法满足视觉语言模型（VLM）训练对“视觉-文本精准对齐”的核心需求。本章将系统介绍如何利用当前主流的视觉大模型（Visual Language Model, VLM）构建一套高效、可扩展的“合成描述工厂”，实现大规模图像数据的自动重标注。我们将深入探讨 Prompt Engineering（提示工程）在精准控制描述颗粒度（从简略到详尽）中的关键作用，破解不同下游任务对描述精度的差异化需求，并引入光学字符识别（OCR）技术作为补充，解决 VLM 对富文本图像（如文档、海报、图表）中文字信息识别不准的痛点，进一步增强模型对复杂图像的理解能力。</p>
<p><strong>学习目标</strong>：
* 深刻理解 Alt-text 的“三宗罪”（不相关、过短、视觉缺失）的本质成因，以及这类低质量描述对视觉语言模型、生成式视觉模型训练的具体危害（如模型幻觉、视觉-文本对齐失效、泛化能力不足等）。
* 掌握使用 vLLM（高效大模型推理引擎）部署 LLaVA、CogVLM 等主流 VLM 的完整流程，理解高吞吐量推理的核心原理，实现大规模图像数据的快速重标注。
* 能够根据不同下游任务（如 CLIP 类双塔模型预训练、Sora 类生成模型训练）设计分层 Prompt 策略，灵活生成简略或详尽的图像描述，精准匹配任务需求。
* 掌握 OCR 技术的核心应用方法，实现 OCR 识别结果与 VLM Prompt 的动态融合，解决文档类、海报类等富文本图像描述质量低下的问题，显著提升这类图像的描述准确性和丰富度。</p>
<p><strong>场景引入</strong>：</p>
<blockquote>
<p>“想象你正在训练一个类 Sora 的模型。你给模型输入了一张图，上面是一只在夕阳下奔跑的金毛犬，背景是埃菲尔铁塔。然而，原始数据的标签却是‘IMG_20240501.jpg’或者‘Best dog food 50% off’。用这种数据训练，模型永远学不会‘金毛犬’和‘埃菲尔铁塔’的视觉对应关系，更别提理解‘夕阳下的光影’了。我们需要通过‘数据重描述’，让 AI 充当标注员，把这只狗和铁塔准确地写进文本里。”</p>
</blockquote>
<h3 id="71-alt-text">7.1 Alt-text 的局限性：为什么原始网页描述不可用？<a class="headerlink" href="#71-alt-text" title="Permanent link">¶</a></h3>
<p>在视觉语言模型和生成式视觉模型的训练过程中，数据质量直接决定模型的上限——而原始网页中的 Alt-text，恰恰是低质量视觉文本数据的主要来源之一。根据 DeepMind（《Scaling Language-Image Pre-training with Weakly Supervised Image-Text Data》）和 OpenAI（《Training language models to follow instructions with human feedback》）的内部研究报告，直接使用互联网爬取的原始 Alt-text 作为训练数据，会导致模型性能提前“封顶”（即无论如何增加数据量，模型的视觉理解、文本生成精度都无法进一步提升），甚至出现性能退化。其核心问题可概括为“三宗罪”，具体分析如下：</p>
<ul>
<li><strong>噪声极大</strong>：大量 Alt-text 仅包含文件名（如“IMG_20240501.jpg”）、日期、无关的 SEO 关键词堆砌（如 "buy cheap shoes nike adidas"“best coffee shop near me”），这类描述与图像视觉内容完全无关。若将其用于训练，不仅无法帮助模型建立视觉-文本的对应关系，还会污染模型的语言能力，导致模型生成无关、冗余的文本，甚至产生严重的幻觉。</li>
<li><strong>视觉缺失</strong>：Alt-text 的设计初衷多是辅助网页功能实现，而非描述视觉内容——它往往只描述图片的功能（如“点击购买按钮”“查看更多详情”）或商业属性（如“红色 XL 码”“限时折扣”），却完全忽略图像本身的视觉细节（如物体的形态、颜色、纹理、空间关系、光影效果等）。例如，一张展示“一件红色的纯棉 T 恤，胸口印着白色的复古 Logo，平铺在木质桌面上”的图片，其 Alt-text 可能仅为“红色 T 恤 促销”，这种描述无法让模型学习到任何视觉特征。</li>
<li><strong>长度过短</strong>：根据 Common Crawl（全球最大的网页爬取数据集）的统计数据，超过 50% 的 Alt-text 长度小于 5 个单词，30% 甚至不足 3 个单词。这种极短的描述无法承载复杂的视觉逻辑、空间关系和细节信息，例如无法描述“一只金毛犬趴在草地上，前爪搭在一个红色皮球上，背景是开满野花的山坡”这类包含多个物体、场景和互动关系的图像。</li>
</ul>
<p><strong>重描述的价值</strong>：数据重描述（Recaptioning）的核心价值，就是通过 AI 自动生成“视觉-文本精准对齐”的高质量描述，替代低质量的原始 Alt-text，打破模型性能的上限。这一点已被业界顶级研究证实——OpenAI 在 DALL-E 3 的论文（《Improving Image Generation with Better Captions》）中明确指出，使用高达 95% 的合成长文本（Synthetic Captions，即通过 VLM 生成的重描述文本）进行训练，是其指令遵循能力、视觉还原精度大幅超越 Stable Diffusion XL（SDXL）的核心原因之一。合成长文本能够精准捕捉图像的视觉细节、逻辑关系和场景氛围，让模型真正学会“看到什么，就描述什么”，进而提升后续的生成、识别、理解能力。</p>
<h3 id="72-vlm">7.2 合成描述工厂：利用 VLM 重生数据<a class="headerlink" href="#72-vlm" title="Permanent link">¶</a></h3>
<p>要实现大规模图像数据的重描述，单靠人工标注不仅成本极高（每标注一张图像需数分钟，大规模数据集动辄数百万、数十亿张图像），还存在标注标准不统一、效率低下的问题。因此，我们需要建立一个由 VLM 驱动的“合成描述工厂”——以原始图像为输入，以高质量、标准化的文本描述为输出，通过自动化、批量化的方式完成数据重标注，实现数据价值的“重生”。</p>
<p>这个“工厂”的核心逻辑的是：将原始图像输入到优化后的 VLM 中，通过精心设计的 Prompt 控制描述的颗粒度和风格，再通过高效的推理引擎提升处理吞吐量，最终输出符合下游任务需求的高质量描述。整个流程可分为“模型选型与架构设计”“Prompt 策略优化”“工程化部署”三个核心环节。</p>
<h4 id="721">7.2.1 模型选型与架构<a class="headerlink" href="#721" title="Permanent link">¶</a></h4>
<p>VLM 的架构直接决定了描述的质量、速度和适用场景。目前主流的 VLM 架构主要分为三类，各类架构的代表模型、优劣对比及推荐场景如下表所示，可根据下游任务的需求（如描述精度、处理速度、数据类型）灵活选型：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">模型架构</th>
<th style="text-align: left;">代表模型</th>
<th style="text-align: left;">优势</th>
<th style="text-align: left;">劣势</th>
<th style="text-align: left;">推荐场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Q-Former连接</strong></td>
<td style="text-align: left;">BLIP-2, InstructBLIP</td>
<td style="text-align: left;">参数量小（通常为数十亿参数，远低于大语言模型），推理速度快（单张图像推理耗时可低至几十毫秒），训练和部署成本低，不易产生文本幻觉（描述内容与图像的贴合度较高）</td>
<td style="text-align: left;">描述长度较短，细节捕捉能力一般，容易出现“复读式描述”（重复提及少量核心物体，缺乏细节延伸），对复杂场景的理解能力有限</td>
<td style="text-align: left;">快速初筛大规模图像（如先对数十亿张图像进行粗略重描述，筛选出有价值的数据），或生成简短的 Alt-text 替代品（适用于对描述长度有严格限制的场景）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>MLP投影 + LLM</strong></td>
<td style="text-align: left;">LLaVA-1.6 / NeXT</td>
<td style="text-align: left;">描述极其详尽，能够捕捉图像中的细微细节（如光影、纹理、物体互动关系），指令遵循能力强（能精准响应 Prompt 中的要求，如“按场景顺序描述”“突出核心物体”），支持多轮对话（可通过多轮 Prompt 优化描述质量）</td>
<td style="text-align: left;">逻辑计算量大（需依赖 7B 及以上参数量的大语言模型，如 LLaMA 2 7B/13B），推理速度相对较慢，若不加 Prompt 约束容易出现啰嗦、冗余的描述</td>
<td style="text-align: left;">主力模型，适用于生成高质量、长文本的 Dense Caption（密集描述），如训练 Sora 类生成模型、SD3 等图像生成模型，需要精准、详尽的视觉-文本对齐数据的场景</td>
</tr>
<tr>
<td style="text-align: left;"><strong>视觉优先架构</strong></td>
<td style="text-align: left;">CogVLM, Qwen-VL</td>
<td style="text-align: left;">视觉分辨率高（支持高清图像输入，部分模型可支持 4K 图像），擅长细粒度物体识别，尤其对富文本图像（如文档、图表、UI 截图）中的文字、小部件（如按钮、输入框）识别精度极高，能够理解文本与视觉元素的关联</td>
<td style="text-align: left;">显存占用较高（部署 7B 参数量模型需至少 24GB 显存），架构非标准（不同模型的部署方式差异较大），部署流程稍繁琐，推理速度中等</td>
<td style="text-align: left;">专门处理文档、图表、UI 截图、海报等富文本数据，如训练能够生成文档图像、UI 界面的模型，或需要精准识别图像中文字信息的场景</td>
</tr>
</tbody>
</table>
<p>补充说明：三类架构的核心差异在于“视觉模块与语言模块的连接方式”：Q-Former 架构通过专门的 Q-Former 模块将视觉特征转换为语言可理解的向量，再输入到轻量语言模型；MLP 投影架构通过多层感知机（MLP）将视觉特征投影到语言模型的嵌入空间，与大语言模型深度融合；视觉优先架构则强化了视觉模块的分辨率和识别能力，弱化了语言模块的冗余计算，更侧重“视觉理解优先”。</p>
<h4 id="722-prompt">7.2.2 Prompt 策略：控制颗粒度<a class="headerlink" href="#722-prompt" title="Permanent link">¶</a></h4>
<p>Prompt Engineering 是“合成描述工厂”的“核心控制器”——同一个 VLM，在不同 Prompt 的引导下，会生成截然不同的数据分布（描述长度、细节丰富度、风格等）。因此，我们需要根据下游任务的具体需求，设计分层 Prompt 策略，精准控制描述的颗粒度，让生成的描述能够完美匹配任务需求。</p>
<p>核心原则：Prompt 的设计需明确“任务指令”“描述范围”“颗粒度要求”，避免模糊表述（如仅用“描述这张图”会导致模型输出不稳定）。同时，可通过加入“约束条件”（如“不超过 20 个单词”“突出核心物体和背景”）进一步优化输出质量。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../images/part3/%E5%9B%BE7_1_%E7%AE%80%E7%95%A5%E4%B8%8E%E8%AF%A6%E7%BB%86%E7%9A%84Prompt%E7%AD%96%E7%95%A5.png" data-desc-position="bottom"><img alt="图7-1：简略与详细的Prompt策略" src="../../images/part3/%E5%9B%BE7_1_%E7%AE%80%E7%95%A5%E4%B8%8E%E8%AF%A6%E7%BB%86%E7%9A%84Prompt%E7%AD%96%E7%95%A5.png"></a>
<em>图7-1：简略与详细的Prompt策略</em></p>
<p>图 7-1 直观对比了两种核心 Prompt 策略的输出差异——简略 Prompt 生成的描述简洁精炼，仅包含核心物体和场景；详细 Prompt 生成的描述则包含丰富的细节，涵盖物体形态、光影、颜色、空间关系等，两种策略分别适配不同的下游任务。</p>
<p>以下是两种最常用的分层 Prompt 策略，可根据实际需求灵活调整，也可在此基础上设计中等颗粒度的 Prompt 策略：</p>
<p><strong>策略一：简略描述 (Brief Caption)</strong>
* <strong>Prompt</strong>: "Describe this image concisely in one sentence."（简洁地用一句话描述这张图像。）
  补充优化 Prompt（增强稳定性）："Describe this image concisely in one sentence, focusing only on the main subject and key background, no redundant details."（简洁地用一句话描述这张图像，仅关注核心物体和关键背景，无冗余细节。）
* <strong>目的</strong>: 适配 CLIP 等双塔模型（视觉-文本双塔架构）的 Context Length 限制——这类模型的文本输入长度通常被限制在 77 个 tokens 以内，过长的描述会被截断，导致模型无法正常学习。同时，也适用于对描述长度有严格要求的场景（如图像检索、快速标注）。
* <strong>预期输出</strong>: "A golden retriever running on grass near the Eiffel Tower."（一只金毛犬在埃菲尔铁塔附近的草地上奔跑。）
  输出特点：长度控制在 10-20 个单词，仅包含核心物体（金毛犬）、关键动作（奔跑）和核心背景（埃菲尔铁塔、草地），无多余细节，简洁明了。</p>
<p><strong>策略二：详尽描述 (Detailed Caption)</strong>
* <strong>Prompt</strong>: "Describe this image in extreme detail. Start with the main subject, then describe the background, lighting, colors, and artistic style. Mention any specific interactions between objects."（极其详细地描述这张图像。从核心物体开始，然后描述背景、光线、颜色和艺术风格。提及物体之间的任何具体互动关系。）
  补充优化 Prompt（增强细节捕捉）："Describe this image in extreme detail. First, describe the main subject's appearance (shape, color, texture), then the background scene, lighting effects (brightness, color temperature), color matching, and artistic style. Finally, mention the interactions between objects and the overall atmosphere of the image."（极其详细地描述这张图像。首先描述核心物体的外观（形态、颜色、纹理），然后描述背景场景、光线效果（亮度、色温）、色彩搭配和艺术风格。最后提及物体之间的互动关系和图像的整体氛围。）
* <strong>目的</strong>: 适配 GenAI 模型（如 Sora、SD3、Ideogram）的训练需求——这类模型需要通过详尽的描述学习到图像的细节特征、逻辑关系和场景氛围，才能生成高精度、符合指令的图像。同时，也适用于需要精准视觉-文本对齐的场景（如视觉问答、图像编辑）。
* <strong>预期输出</strong>: "A dynamic wide-angle shot of a fluffy golden retriever running joyfully across a green lawn. The dog's fur is illuminated by the warm, golden light of a setting sun, with some light brown strands glinting in the sunlight. Its ears flop backward as it runs, and its tail is raised high, showing a happy mood. In the blurred background, the iconic iron lattice structure of the Eiffel Tower rises against a gradient sky of purple and orange, with a few wispy clouds floating nearby. The lawn is dotted with small white clover flowers, and the overall atmosphere of the image is warm and lively, with soft focus on the dog and a blurred background that highlights the main subject."（一张动态广角镜头下的毛茸茸金毛犬，正欢快地奔跑在绿色的草地上。狗狗的毛发被夕阳温暖的金色光线照亮，几缕浅棕色的毛发在阳光下闪闪发光。它奔跑时耳朵向后耷拉着，尾巴高高翘起，尽显欢快的心情。在模糊的背景中，标志性的埃菲尔铁塔铁 lattice 结构矗立在紫橙渐变的天空下，旁边漂浮着几缕纤细的云朵。草地上点缀着小小的白色三叶草花，图像的整体氛围温暖而活泼，狗狗采用柔焦处理，背景模糊以突出核心主体。）
  输出特点：长度通常在 50-200 个单词，涵盖核心物体的细节、背景场景、光线、色彩、艺术风格、物体互动和整体氛围，细节丰富，视觉-文本对齐精度高。</p>
<p>补充提示：除了上述两种策略，还可设计“任务导向型 Prompt”，如针对电商图像的 Prompt（"Describe this product image in detail, focusing on the product's appearance, color, size, texture, and placement, suitable for e-commerce promotion"）、针对文档图像的 Prompt（"Describe this document image in detail, including the text content, layout, font style, and color of the text"），进一步提升描述的针对性。</p>
<h4 id="723-vllm">7.2.3 工程实现：使用 vLLM 构建高吞吐推理服务<a class="headerlink" href="#723-vllm" title="Permanent link">¶</a></h4>
<p>对于大规模数据重描述（如处理 10 亿级别的图像数据集），普通的 HuggingFace <code>generate()</code> 方法远远无法满足需求——其推理速度慢、吞吐量低，且无法高效利用 GPU 资源，单张 GPU 一天仅能处理数千张图像，大规模处理会耗费大量的时间和硬件成本。因此，我们需要使用专门的大模型推理引擎——vLLM，其支持 PagedAttention（分页注意力）和 Continuous Batching（连续批处理）两种核心优化技术，能够将 VLM 的推理吞吐量提升 3-5 倍，同时降低 GPU 显存占用，实现高效、大规模的图像重描述。</p>
<p>vLLM 是由加州大学伯克利分校的研究团队开发的高效大模型推理引擎，核心优势是“高吞吐量、低延迟、高 GPU 利用率”，能够完美适配 LLaVA、CogVLM 等主流 VLM 的部署需求，且 API 接口与 HuggingFace 兼容，迁移成本极低。</p>
<p>以下是使用 vLLM 部署 LLaVA-1.5-7b-hf 模型，实现高吞吐量图像重描述的核心代码，包含模型初始化、Prompt 模板设计、批量处理和输出提取等完整流程，并补充了关键参数的解读和优化技巧：</p>
<p></p><div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vllm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LLM</span><span class="p">,</span> <span class="n">SamplingParams</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>  <span class="c1"># 用于显示批量处理进度</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="c1"># 初始化 vLLM 推理引擎</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="c1"># tensor_parallel_size=4: 使用 4 张 GPU 进行张量并行，适用于大模型（如7B/13B）的部署，可根据GPU数量调整（如1、2、4、8）</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="c1"># 注意：张量并行需要多张同型号的GPU，且GPU之间需支持NVLink，提升数据传输速度</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="c1"># trust_remote_code=True: 允许加载 LLaVA 模型的自定义代码（如视觉-语言融合模块），因LLaVA的架构非标准HuggingFace模型</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="c1"># model: 模型名称，可从HuggingFace Hub下载（如llava-hf/llava-1.5-7b-hf、llava-hf/llava-1.5-13b-hf）</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="c1"># gpu_memory_utilization=0.9: 设置GPU显存利用率为90%，平衡吞吐量和稳定性，避免显存溢出</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="n">llm</span> <span class="o">=</span> <span class="n">LLM</span><span class="p">(</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">"llava-hf/llava-1.5-7b-hf"</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="n">tensor_parallel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">gpu_memory_utilization</span><span class="o">=</span><span class="mf">0.9</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="c1"># 定义 Prompt 模板 (LLaVA 模型需要遵循特定的对话格式，否则会影响指令遵循能力)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="c1"># 技巧: 在 Prompt 中加入 "Analyze the image" 往往比 "Describe the image" 效果更好，</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="c1"># 因为"Analyze"会引导模型更细致地观察图像细节，减少敷衍式描述</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="c1"># 此处使用详尽描述的 Prompt 模板，可根据需求替换为简略描述模板</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="n">prompt_template</span> <span class="o">=</span> <span class="s2">"USER: &lt;image&gt;</span><span class="se">\n</span><span class="s2">Analyze this image and describe it in extreme detail. Start with the main subject, then describe the background, lighting, colors, and artistic style. Mention any specific interactions between objects. ASSISTANT:"</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="c1"># 配置采样参数，控制生成描述的质量和稳定性</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="c1"># temperature=0.2: 降低随机性（取值范围0-1），温度越低，生成的描述越稳定、越贴合图像，减少幻觉；</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="c1"># 若需要更多样化的描述，可将温度调整为0.5-0.7，但若温度过高（&gt;0.8），容易产生与图像无关的幻觉</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="c1"># max_tokens=256: 限制输出长度，防止模型生成过于冗长、冗余的描述，可根据需求调整（如简略描述设为50）</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="c1"># top_p=0.95: 采用核采样策略，仅保留累积概率达到95%的token，进一步降低幻觉风险</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="n">sampling_params</span> <span class="o">=</span> <span class="n">SamplingParams</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="n">max_tokens</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="n">top_p</span><span class="o">=</span><span class="mf">0.95</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_image_batch</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="sd">    批量加载图像，用于高效处理</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="sd">    image_dir: 图像文件夹路径，所有图像需放在该文件夹下</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="sd">    batch_size: 每批处理的图像数量，可根据GPU显存调整（如16、32、64），显存越大，batch_size可设置越大</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="sd">    return: 批量图像列表（PIL.Image格式）和对应的图像路径列表</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="sd">    """</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>    <span class="n">image_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">image_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">'jpg'</span><span class="p">,</span> <span class="s1">'png'</span><span class="p">,</span> <span class="s1">'jpeg'</span><span class="p">))]</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>    <span class="n">image_batches</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>    <span class="n">path_batches</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>    <span class="c1"># 分批加载图像</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_paths</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="n">batch_paths</span> <span class="o">=</span> <span class="n">image_paths</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="n">batch_images</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">batch_paths</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>                <span class="c1"># 加载图像并转换为RGB格式（避免灰度图、透明图导致的模型报错）</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">'RGB'</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>                <span class="n">batch_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"加载图像 </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> 失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>                <span class="k">continue</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>        <span class="k">if</span> <span class="n">batch_images</span><span class="p">:</span>  <span class="c1"># 跳过为空的批次</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>            <span class="n">image_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_images</span><span class="p">)</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>            <span class="n">path_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_paths</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>    <span class="k">return</span> <span class="n">image_batches</span><span class="p">,</span> <span class="n">path_batches</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_batch</span><span class="p">(</span><span class="n">image_batch</span><span class="p">):</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a><span class="sd">    处理一批图片，生成对应的重描述文本</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a><span class="sd">    image_batch: List[PIL.Image]，批量图像列表</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a><span class="sd">    return: List[str]，每幅图像对应的重描述文本列表</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a><span class="sd">    """</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>    <span class="c1"># 为每幅图像生成对应的Prompt</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>    <span class="n">prompts</span> <span class="o">=</span> <span class="p">[</span><span class="n">prompt_template</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_batch</span><span class="p">))]</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>    <span class="c1"># vLLM 支持直接传入 multi_modal_data（多模态数据），无需手动转换图像格式</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>    <span class="c1"># 这一步是非阻塞的，vLLM 内部会进行 Continuous Batching 调度，高效利用GPU资源</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>    <span class="c1"># 即当一批图像处理完成一部分时，立即加载下一批图像的部分数据，避免GPU空闲</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>    <span class="n">outputs</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>        <span class="n">prompts</span><span class="p">,</span> 
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>        <span class="n">sampling_params</span><span class="p">,</span> 
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>        <span class="n">multi_modal_data</span><span class="o">=</span><span class="p">{</span><span class="s2">"image"</span><span class="p">:</span> <span class="n">image_batch</span><span class="p">}</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>    <span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>    <span class="c1"># 提取生成的描述文本，去除Prompt部分，仅保留模型的响应内容</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>    <span class="n">captions</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>        <span class="c1"># 截取ASSISTANT: 后面的内容，即为模型生成的描述</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>        <span class="n">caption</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"ASSISTANT:"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>        <span class="n">captions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">caption</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>    <span class="k">return</span> <span class="n">captions</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_captions</span><span class="p">(</span><span class="n">image_paths</span><span class="p">,</span> <span class="n">captions</span><span class="p">,</span> <span class="n">save_path</span><span class="p">):</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a><span class="sd">    保存重描述文本，与图像路径对应，便于后续使用（如模型训练）</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a><span class="sd">    image_paths: 图像路径列表</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a><span class="sd">    captions: 重描述文本列表</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a><span class="sd">    save_path: 保存文件路径（txt格式）</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a><span class="sd">    """</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">cap</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image_paths</span><span class="p">,</span> <span class="n">captions</span><span class="p">):</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>            <span class="c1"># 格式：图像路径\t重描述文本，便于后续读取和解析</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">cap</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a><span class="c1"># 主函数：批量处理图像并生成重描述</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>    <span class="n">image_dir</span> <span class="o">=</span> <span class="s2">"path/to/your/image/directory"</span>  <span class="c1"># 替换为你的图像文件夹路径</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>    <span class="n">save_path</span> <span class="o">=</span> <span class="s2">"recaption_results.txt"</span>        <span class="c1"># 重描述结果保存路径</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>                            <span class="c1"># 每批处理图像数量，根据GPU显存调整</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>    <span class="c1"># 加载图像批次</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>    <span class="n">image_batches</span><span class="p">,</span> <span class="n">path_batches</span> <span class="o">=</span> <span class="n">load_image_batch</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>    <span class="c1"># 批量处理并保存结果</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>        <span class="k">for</span> <span class="n">img_batch</span><span class="p">,</span> <span class="n">path_batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">image_batches</span><span class="p">,</span> <span class="n">path_batches</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">image_batches</span><span class="p">)):</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>            <span class="n">captions</span> <span class="o">=</span> <span class="n">process_batch</span><span class="p">(</span><span class="n">img_batch</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>            <span class="c1"># 写入当前批次的结果</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">cap</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">path_batch</span><span class="p">,</span> <span class="n">captions</span><span class="p">):</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">cap</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"重描述完成，结果已保存至 </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
补充工程优化技巧：<p></p>
<ul>
<li><strong>图像预处理</strong>：批量加载图像时，可统一调整图像尺寸（如 resize 到 224×224 或 448×448），避免因图像尺寸差异导致的模型推理速度波动和显存占用不稳定；同时，可对图像进行归一化处理，提升模型描述精度。</li>
<li><strong>错误处理</strong>：增加图像加载失败、模型推理失败的异常捕获机制，避免批量处理中断；对于处理失败的图像，可记录路径并单独处理。</li>
<li><strong>硬件优化</strong>：部署时优先使用 NVIDIA A100、A800 等高性能 GPU，显存建议不低于 24GB（7B 模型）；若处理规模极大，可使用 GPU 集群，通过 vLLM 的分布式推理功能进一步提升吞吐量。</li>
<li><strong>Prompt 缓存</strong>：对于相同类型的图像（如批量的电商海报），可缓存 Prompt 模板，避免重复生成，提升处理速度。</li>
</ul>
<h3 id="73-ocr">7.3 OCR 增强：提取图中文字并融合<a class="headerlink" href="#73-ocr" title="Permanent link">¶</a></h3>
<p>普通的 VLM 虽然具备一定的视觉理解能力，能够识别图像中的物体、场景和简单文字，但在面对密集文本图像（如文档、海报、图表、PDF 截图）时，往往会出现两个核心问题：一是文字识别精度低，容易认错、漏认文字（尤其是艺术字体、模糊文字）；二是无法将文字信息与视觉元素有效关联，导致描述中忽略文字的含义和作用。</p>
<p>例如，一张电商海报上有 “夏日促销 全场 5 折起” 的大字，普通 VLM 可能仅输出 “A red promotional poster”，完全忽略文字信息；即使识别到文字，也可能出现 “夏日促销 全场 3 折起” 的错误。而文字信息对于这类图像的重描述至关重要 —— 它直接决定了图像的核心含义和用途。</p>
<p>最佳实践是引入专门的 OCR 引擎（如 PaddleOCR、Tesseract）作为 VLM 的 “外挂大脑”，通过 OCR 精准提取图像中的文字信息，再将其与 VLM Prompt 动态融合，让 VLM 能够结合文字信息生成更准确、更丰富的描述，显著提升文档类、海报类等富文本图像的重描述质量。</p>
<p>OCR（Optical Character Recognition，光学字符识别）技术的核心是将图像中的印刷体、手写体文字转换为可编辑的文本，其文字识别精度远高于普通 VLM，尤其是在密集文本、复杂字体场景下，优势更为明显。目前，工业界应用最广泛、开源免费且精度较高的 OCR 引擎是 PaddleOCR（百度飞桨开源的 OCR 工具），它支持多语言、多字体、模糊文本的识别，且推理速度快、部署简单，支持 GPU 加速，非常适合与 VLM 结合使用。</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../images/part3/%E5%9B%BE7_2_OCR%E5%A2%9E%E5%BC%BA%E6%B5%81%E6%B0%B4%E7%BA%BF.png" data-desc-position="bottom"><img alt="图7-2：OCR 增强流水线" src="../../images/part3/%E5%9B%BE7_2_OCR%E5%A2%9E%E5%BC%BA%E6%B5%81%E6%B0%B4%E7%BA%BF.png"></a>
<em>图7-2：OCR 增强流水线</em></p>
<p><strong>图表核心解读</strong>：图 7-2 展示了 OCR 增强 VLM 重描述的完整流程，核心是 “OCR 提取文字→上下文构建→Prompt 融合→VLM 生成描述”，通过 OCR 补充 VLM 的文字识别短板，实现 “视觉细节 + 文字信息” 的双重精准描述。</p>
<h4 id="731-ocr">7.3.1 OCR 增强流水线<a class="headerlink" href="#731-ocr" title="Permanent link">¶</a></h4>
<p>OCR 增强的核心是将 OCR 提取的文字信息与 VLM Prompt 有机融合，而非简单拼接。整个流水线可分为三个核心步骤，每个步骤都有明确的优化方向，确保文字信息能够有效提升重描述质量：</p>
<ol>
<li><strong>检测与识别</strong>：使用 PaddleOCR 引擎对原始图像进行处理，首先检测出图像中的所有文本区域（通过 Bounding Box 定位文本的位置），然后对每个文本区域进行字符识别，输出识别到的文本内容和对应的置信度（0-1 之间，置信度越高，识别结果越准确）。这一步的核心目标是 “精准提取文字，过滤错误识别结果”—— 通过置信度阈值过滤低精度识别结果，避免错误文字误导 VLM。</li>
<li><strong>上下文构建</strong>：将 OCR 提取到的所有有效文本（过滤低置信度后），按照图像中文字的实际位置（从上到下、从左到右，多列文本按列排序）进行拼接，构建出符合人类阅读习惯的文本上下文。同时，可对文本进行简单分类整理（如将标题文字、正文文字、按钮文字区分开），便于 VLM 理解文字的层级关系和作用。例如，一张海报上的文字 “夏日促销”（标题）、“全场 5 折起”（副标题）、“6 月 1 日 - 6 月 10 日”（时间），拼接后可得到 “夏日促销，全场 5 折起，6 月 1 日 - 6 月 10 日”，并标注标题和正文。</li>
<li><strong>Prompt 融合</strong>：将构建好的文本上下文，以自然的方式融入到 VLM 的 Prompt 中，明确告诉 VLM“图像中包含这些文字信息，请结合文字和视觉元素进行描述”，引导 VLM 关联文字与视觉元素（如文字的位置、颜色、字体风格，以及文字所表达的含义与图像场景的关系）。这一步的关键是 “融合自然，不冗余”，避免将文字生硬拼接在 Prompt 末尾，导致 VLM 忽略视觉细节。</li>
</ol>
<p><strong>补充说明</strong>：流水线的优化重点是 “置信度过滤” 和 “Prompt 融合”—— 若未过滤低置信度文本，错误的文字会导致 VLM 生成错误描述；若 Prompt 融合生硬，VLM 会将文字与视觉元素割裂，无法实现真正的增强效果。</p>
<h4 id="732-ocr">7.3.2 核心代码：OCR 结果注入<a class="headerlink" href="#732-ocr" title="Permanent link">¶</a></h4>
<p>以下是使用 PaddleOCR 提取图像文字，并将其动态融合到 VLM Prompt 中的核心代码，可与 7.2.3 节的 vLLM 批量处理代码无缝对接，实现 OCR 增强的大规模图像重描述。代码中包含了文字提取、置信度过滤、上下文构建、Prompt 融合等完整逻辑，并补充了关键参数解读和优化技巧：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">paddleocr</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaddleOCR</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="c1"># 初始化 OCR 引擎 (建议在 GPU 上运行以加速，若没有 GPU，可设置 use_gpu=False)</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="c1"># use_angle_cls=True: 开启文本方向检测，支持倾斜文本（如倾斜的海报文字、旋转的文档）的识别，避免因文本倾斜导致识别错误</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="c1"># lang='en': 识别语言为英文，若需要识别中文，可设置 lang='ch'，支持中英双语混合识别（lang='ch_en'）</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="c1"># det_model_dir、rec_model_dir: 可指定 OCR 检测模型和识别模型的路径，若不指定，会自动下载预训练模型</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="c1"># gpu_mem=500: 设置 GPU 显存占用上限（单位：MB），可根据 GPU 显存调整</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="n">ocr</span> <span class="o">=</span> <span class="n">PaddleOCR</span><span class="p">(</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    <span class="n">use_angle_cls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="n">lang</span><span class="o">=</span><span class="s1">'en'</span><span class="p">,</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    <span class="n">use_gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>    <span class="n">gpu_mem</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_ocr_enhanced_prompt</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">base_prompt</span><span class="o">=</span><span class="s2">"Describe this image in detail."</span><span class="p">):</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="sd">    生成 OCR 增强的 VLM Prompt，将 OCR 提取的文字信息融入 Prompt 中</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="sd">    image_path: 原始图像路径</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="sd">    base_prompt: 基础 Prompt（如简略描述、详尽描述的 Prompt），作为 Prompt 主体</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="sd">    return: OCR 增强后的完整 Prompt，若未识别到有效文字，返回基础 Prompt</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="sd">    """</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>    <span class="c1"># Step 1: 运行 OCR，提取图像中的文字和置信度</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>    <span class="c1"># result 是一个嵌套列表，结构为：[[[[x1,y1], [x2,y2], [x3,y3], [x4,y4]], [text, confidence]], ...]</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>    <span class="c1"># 其中 [x1,y1]~[x4,y4] 是文本区域的 Bounding Box（左上角、右上角、右下角、左下角坐标）</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>    <span class="c1"># text 是识别到的文本内容，confidence 是识别置信度</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">ocr</span><span class="o">.</span><span class="n">ocr</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>    <span class="c1"># 处理 OCR 结果：若未识别到文字，或识别结果为空，回退到普通基础 Prompt</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"USER: &lt;image&gt;</span><span class="se">\n</span><span class="si">{</span><span class="n">base_prompt</span><span class="si">}</span><span class="se">\n</span><span class="s2">ASSISTANT:"</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>    <span class="c1"># Step 2: 提取有效文字（过滤低置信度结果），构建文本上下文</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>    <span class="n">detected_texts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 识别到的文本内容</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>        <span class="n">confidence</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 识别置信度</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>        <span class="c1"># 过滤置信度低于 0.8 的结果（阈值可调整，如0.7-0.9，根据图像文字清晰度调整）</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>        <span class="c1"># 同时过滤空文本和无意义的乱码（如仅包含符号、空格的文本）</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>        <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="mf">0.8</span> <span class="ow">and</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a>            <span class="n">detected_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>    <span class="c1"># 构建文本上下文：按识别顺序拼接文本，用逗号分隔，确保符合人类阅读习惯</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a>    <span class="n">ocr_context</span> <span class="o">=</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">detected_texts</span><span class="p">)</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>    <span class="c1"># Step 3: 动态融合 OCR 结果与基础 Prompt，生成增强 Prompt</span>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>    <span class="c1"># 关键技巧：告诉模型 "I have detected these texts..."，让模型明确知道这是图像中的文字，</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>    <span class="c1"># 并引导模型将文字与视觉元素关联（如文字的位置、颜色、字体，以及文字含义与场景的关系）</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ocr_context</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># 只有文本长度足够长（超过10个字符），才有增强价值，避免冗余</span>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>        <span class="n">enhanced_prompt</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a>            <span class="sa">f</span><span class="s2">"USER: &lt;image&gt;</span><span class="se">\n</span><span class="s2">"</span>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>            <span class="sa">f</span><span class="s2">"I have detected these text segments in the image: '</span><span class="si">{</span><span class="n">ocr_context</span><span class="si">}</span><span class="s2">'. "</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>            <span class="sa">f</span><span class="s2">"Using this text as a reference, describe the image in detail, "</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>            <span class="sa">f</span><span class="s2">"paying attention to how the text relates to the visual elements (such as the position, color, and font style of the text, "</span>
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>            <span class="sa">f</span><span class="s2">"and the connection between the text content and the image scene). </span><span class="si">{</span><span class="n">base_prompt</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a>            <span class="sa">f</span><span class="s2">"ASSISTANT:"</span>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>        <span class="p">)</span>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>        <span class="k">return</span> <span class="n">enhanced_prompt</span>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a>        <span class="c1"># 若文本过短（如仅1-2个单词），不进行增强，避免冗余，回退到基础 Prompt</span>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"USER: &lt;image&gt;</span><span class="se">\n</span><span class="si">{</span><span class="n">base_prompt</span><span class="si">}</span><span class="se">\n</span><span class="s2">ASSISTANT:"</span>
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a>
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a><span class="c1"># 测试代码：验证 OCR 增强 Prompt 的生成效果</span>
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a>    <span class="c1"># 测试图像路径（可替换为你的富文本图像路径，如海报、文档截图）</span>
<a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a>    <span class="n">test_image_path</span> <span class="o">=</span> <span class="s2">"path/to/your/test/poster.jpg"</span>
<a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a>    <span class="c1"># 基础 Prompt（采用详尽描述模板）</span>
<a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a>    <span class="n">base_prompt</span> <span class="o">=</span> <span class="s2">"Describe this image in extreme detail. Start with the main subject, then describe the background, lighting, colors, and artistic style."</span>
<a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a>    <span class="c1"># 生成增强 Prompt</span>
<a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a>    <span class="n">enhanced_prompt</span> <span class="o">=</span> <span class="n">generate_ocr_enhanced_prompt</span><span class="p">(</span><span class="n">test_image_path</span><span class="p">,</span> <span class="n">base_prompt</span><span class="p">)</span>
<a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"OCR 增强后的 Prompt:"</span><span class="p">)</span>
<a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">enhanced_prompt</span><span class="p">)</span>
</code></pre></div>
<p><strong>补充优化技巧：</strong></p>
<ul>
<li><strong>置信度阈值调整</strong>：对于文字清晰的图像（如高清文档、正规海报），可将置信度阈值调整为 0.8-0.9，过滤少量错误结果；对于文字模糊、字体复杂的图像（如老旧海报、手写体），可将阈值调整为 0.7-0.8，避免漏认有效文字。</li>
<li><strong>文本上下文优化</strong>：对于多列文本、层级文本（如标题、正文、脚注），可结合 Bounding Box 的坐标信息，对文本进行分类拼接，例如 “标题：夏日促销；正文：全场 5 折起，6 月 1 日 - 6 月 10 日；脚注：最终解释权归本店所有”，让 VLM 更清晰地理解文字的层级关系。</li>
<li><strong>Prompt 融合优化</strong>：根据图像类型调整融合话术，如文档图像可加入 “Describe the layout of the text and the relationship between the text and the document structure”，海报图像可加入 “Describe the font style of the text and the role of the text in the promotional scene”，提升描述的针对性。</li>
<li><strong>多 OCR 引擎融合</strong>：对于极高精度要求的场景，可同时使用 PaddleOCR 和 Tesseract 两种引擎，取两者识别结果的交集，进一步提升文字识别精度。</li>
</ul>
<p><strong>实战收益</strong>：OCR 增强对富文本图像的重描述质量提升效果极其显著，以下是一个典型的实战对比案例：</p>
<ul>
<li><strong>普通 VLM（无 OCR 增强）对电商海报的描述</strong>："A red promotional poster with a white background, featuring some vague text and a button at the bottom."（一张红色的促销海报，白色背景，包含一些模糊的文字和底部的一个按钮。）</li>
<li><strong>OCR 增强后 VLM 的描述</strong>："A promotional red poster with a white background, featuring the text 'SUMMER SALE 50% OFF' in large white bold letters at the top center of the poster, and 'Shop Now' in a small blue button at the bottom right. The text 'SUMMER SALE' is in a decorative font, with a yellow shadow effect that makes it stand out. The overall layout is simple and eye-catching, focusing on highlighting the promotional information. The background is plain white, which makes the red poster and white text more prominent."（一张红色的促销海报，白色背景，海报顶部中央有大号白色粗体文字 “SUMMER SALE 50% OFF”，右下角的蓝色小按钮上有 “Shop Now” 字样。“SUMMER SALE” 采用装饰字体，带有黄色阴影效果，使其更加突出。整体布局简洁醒目，重点突出促销信息。背景为纯白色，让红色海报和白色文字更加显眼。）</li>
</ul>
<p>这种差异对于训练能够生成准确文字的模型（如 Ideogram、SD3、文档生成模型）至关重要 —— 包含精准文字信息的重描述，能够让模型学会 “文字的视觉呈现方式” 和 “文字与场景的关联关系”，从而生成更符合需求的图像。同时，对于视觉问答、图像检索等任务，OCR 增强后的描述也能提升任务精度，让模型更好地理解图像的核心含义。</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚">
        
          
          <a href="../3_1_image_text_pairs/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 第6章：图文对数据处理">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                第6章：图文对数据处理
              </div>
            </div>
          </a>
        
        
          
          <a href="../3_3_video_audio/" class="md-footer__link md-footer__link--next" aria-label="下一页: 第8章：视频与音频数据">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                第8章：视频与音频数据
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.sections", "navigation.expand", "navigation.indexes", "navigation.top", "navigation.footer", "toc.follow", "search.suggest", "content.code.copy"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>