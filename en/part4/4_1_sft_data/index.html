<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="大模型数据工程：架构、算法及项目实战">
      
      
        <meta name="author" content="ustc">
      
      
        <link rel="canonical" href="https://datascale-ai.github.io/data_engineering_book/en/part4/4_1_sft_data/">
      
      
        <link rel="prev" href="../../part3/3_3_video_audio/">
      
      
        <link rel="next" href="../4_2_synthetic_data/">
      
      
        
          <link rel="alternate" href="../../../part4/4_1_sft_data/" hreflang="zh">
        
          <link rel="alternate" href="./" hreflang="en">
        
          <link rel="alternate" href="../../../ja/part4/4_1_sft_data/" hreflang="ja">
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>Chapter 9: Instruction Fine-tuning Data - Data Engineering for Large Models: Architecture, Algorithms &amp; Projects</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chapter-9-instruction-fine-tuning-data-sft-data-building-the-models-code-of-conduct" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../" title="Data Engineering for Large Models: Architecture, Algorithms &amp; Projects" class="md-header__button md-logo" aria-label="Data Engineering for Large Models: Architecture, Algorithms &amp; Projects" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Data Engineering for Large Models: Architecture, Algorithms &amp; Projects
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Chapter 9: Instruction Fine-tuning Data
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="red" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"></path></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../../part4/4_1_sft_data/" hreflang="zh" class="md-select__link">
              简体中文
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../../ja/part4/4_1_sft_data/" hreflang="ja" class="md-select__link">
              日本語
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/datascale-ai/data_engineering_book/tree/main" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../" title="Data Engineering for Large Models: Architecture, Algorithms &amp; Projects" class="md-nav__button md-logo" aria-label="Data Engineering for Large Models: Architecture, Algorithms &amp; Projects" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    Data Engineering for Large Models: Architecture, Algorithms &amp; Projects
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/datascale-ai/data_engineering_book/tree/main" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Table of Contents
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Part 1: Infrastructure &amp; Core Concepts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Part 1: Infrastructure &amp; Core Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/1_1_data_change/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1: Data Revolution in the LLM Era
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/1_2_data_infra/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 2: Data Infrastructure Selection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3">
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Part 2: Text Pre-training Data Engineering
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Part 2: Text Pre-training Data Engineering
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/2_1_data_acquisition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 3: Data Acquisition
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/2_2_cleaning_denoising/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 4: Cleaning &amp; Deduplication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/2_3_tokenization_serialization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5: Tokenization &amp; Serialization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4">
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Part 3: Multimodal Data Engineering
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Part 3: Multimodal Data Engineering
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/3_1_image_text_pairs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 6: Image-Text Pair Processing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/3_2_recaptioning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 7: Recaptioning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/3_3_video_audio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 8: Video &amp; Audio Data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Part 4: Alignment &amp; Synthetic Data Engineering
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Part 4: Alignment &amp; Synthetic Data Engineering
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Chapter 9: Instruction Fine-tuning Data
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 9: Instruction Fine-tuning Data
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chapter-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Chapter Summary
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Chapter Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#learning-objectives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Learning Objectives
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#91-core-concepts-and-principles-concepts-principles" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1. Core Concepts and Principles (Concepts &amp; Principles)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.1. Core Concepts and Principles (Concepts &amp; Principles)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#911-why-quality-matters-more-than-quantity-the-surface-form-hypothesis" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1.1 Why Quality Matters More Than Quantity? — The Surface Form Hypothesis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#912-engineering-perspective-on-prompt-engineering" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1.2 Engineering Perspective on Prompt Engineering
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#913-automated-construction-methodology" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1.3 Automated Construction Methodology
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#914-chain-of-thought-cot-data-breaking-the-reasoning-black-box" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1.4 Chain-of-Thought (CoT) Data: Breaking the Reasoning Black Box
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#915-data-format-standardization-data-formatting-standards" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1.5 Data Format Standardization (Data Formatting Standards)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#92-engineering-implementation-engineering-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2. Engineering Implementation (Engineering Implementation)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.2. Engineering Implementation (Engineering Implementation)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environmentdependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Environment/Dependencies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#921-prompt-engineering-for-data-production" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2.1 Prompt Engineering for Data Production
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.2.1 Prompt Engineering for Data Production">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-objective-construct-a-batch-of-instruction-data-for-training-a-financial-analysis-assistant" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Objective: Construct a batch of instruction data for training a "Financial Analysis Assistant."
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#922-automated-construction-methods-self-instruct-and-evol-instruct" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2.2 Automated Construction Methods: Self-Instruct and Evol-Instruct
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.2.2 Automated Construction Methods: Self-Instruct and Evol-Instruct">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-code-breakdown-evol-instruct-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Code Breakdown: Evol-Instruct Pipeline
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#923-chain-of-thought-cot-data-constructing-step-by-step-reasoning-samples" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2.3 Chain-of-Thought (CoT) Data: Constructing Step-by-Step Reasoning Samples
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.2.3 Chain-of-Thought (CoT) Data: Constructing Step-by-Step Reasoning Samples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cot-data-construction-prompt-template" class="md-nav__link">
    <span class="md-ellipsis">
      
        CoT Data Construction Prompt Template
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#924-performance-and-evaluation-performance-evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2.4. Performance and Evaluation (Performance &amp; Evaluation)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.2.4. Performance and Evaluation (Performance &amp; Evaluation)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#evaluation-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Evaluation Metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benchmarks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Benchmarks
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#925-pitfalls-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2.5. Pitfalls &amp; Troubleshooting
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#926-chapter-summary-and-further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2.6. Chapter Summary and Further Reading
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.2.6. Chapter Summary and Further Reading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#references-and-further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      
        References and Further Reading
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4_2_synthetic_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 10: Synthetic Data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4_3_preference_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 11: Human Preference Data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6">
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Part 5: Application-level Data Engineering
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Part 5: Application-level Data Engineering
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/5_1_rag_pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 12: RAG Data Pipeline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/5_2_mm_rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 13: Multimodal RAG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7">
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Part 6: Capstone Projects
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Part 6: Capstone Projects
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_1_mini_c4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Project 1: Building Mini-C4 Pre-training Set
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_2_legal_sft/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Project 2: Domain Expert SFT
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_3_llava_instruct/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Project 3: Building LLaVA Multimodal Instruction Set
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_4_synthetic_textbook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Project 4: Synthetic Math/Code Textbook
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/6_5_mm_rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Project 5: Multimodal RAG Financial Report Assistant
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chapter-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Chapter Summary
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Chapter Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#learning-objectives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Learning Objectives
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#91-core-concepts-and-principles-concepts-principles" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1. Core Concepts and Principles (Concepts &amp; Principles)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.1. Core Concepts and Principles (Concepts &amp; Principles)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#911-why-quality-matters-more-than-quantity-the-surface-form-hypothesis" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1.1 Why Quality Matters More Than Quantity? — The Surface Form Hypothesis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#912-engineering-perspective-on-prompt-engineering" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1.2 Engineering Perspective on Prompt Engineering
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#913-automated-construction-methodology" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1.3 Automated Construction Methodology
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#914-chain-of-thought-cot-data-breaking-the-reasoning-black-box" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1.4 Chain-of-Thought (CoT) Data: Breaking the Reasoning Black Box
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#915-data-format-standardization-data-formatting-standards" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1.5 Data Format Standardization (Data Formatting Standards)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#92-engineering-implementation-engineering-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2. Engineering Implementation (Engineering Implementation)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.2. Engineering Implementation (Engineering Implementation)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environmentdependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Environment/Dependencies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#921-prompt-engineering-for-data-production" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2.1 Prompt Engineering for Data Production
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.2.1 Prompt Engineering for Data Production">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-objective-construct-a-batch-of-instruction-data-for-training-a-financial-analysis-assistant" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Objective: Construct a batch of instruction data for training a "Financial Analysis Assistant."
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#922-automated-construction-methods-self-instruct-and-evol-instruct" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2.2 Automated Construction Methods: Self-Instruct and Evol-Instruct
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.2.2 Automated Construction Methods: Self-Instruct and Evol-Instruct">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-code-breakdown-evol-instruct-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Code Breakdown: Evol-Instruct Pipeline
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#923-chain-of-thought-cot-data-constructing-step-by-step-reasoning-samples" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2.3 Chain-of-Thought (CoT) Data: Constructing Step-by-Step Reasoning Samples
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.2.3 Chain-of-Thought (CoT) Data: Constructing Step-by-Step Reasoning Samples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cot-data-construction-prompt-template" class="md-nav__link">
    <span class="md-ellipsis">
      
        CoT Data Construction Prompt Template
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#924-performance-and-evaluation-performance-evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2.4. Performance and Evaluation (Performance &amp; Evaluation)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.2.4. Performance and Evaluation (Performance &amp; Evaluation)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#evaluation-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Evaluation Metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benchmarks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Benchmarks
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#925-pitfalls-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2.5. Pitfalls &amp; Troubleshooting
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#926-chapter-summary-and-further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2.6. Chapter Summary and Further Reading
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.2.6. Chapter Summary and Further Reading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#references-and-further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      
        References and Further Reading
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="chapter-9-instruction-fine-tuning-data-sft-data-building-the-models-code-of-conduct">Chapter 9: Instruction Fine-Tuning Data (SFT Data) —— Building the Model's "Code of Conduct"<a class="headerlink" href="#chapter-9-instruction-fine-tuning-data-sft-data-building-the-models-code-of-conduct" title="Permanent link">¶</a></h1>
<h2 id="chapter-summary">Chapter Summary<a class="headerlink" href="#chapter-summary" title="Permanent link">¶</a></h2>
<p>This chapter delves into a critical phase in the lifecycle of Large Language Models (LLMs)—the key transition from "general pre-training" to "specific instruction following." We move beyond simple data collection to explore how to build high-quality SFT (Supervised Fine-Tuning) datasets through highly engineered Prompt systems and automated pipelines (Self-Instruct, Evol-Instruct). Beyond technical implementation, we also analyze the theoretical foundations: Why can a small amount of high-quality data unlock enormous model capabilities? We focus on addressing insufficient data diversity, inadequate instruction complexity, and missing reasoning ability, ultimately building an intelligent agent that understands both knowledge and rules.</p>
<h3 id="learning-objectives">Learning Objectives<a class="headerlink" href="#learning-objectives" title="Permanent link">¶</a></h3>
<ul>
<li><strong>Master iterative System Prompt engineering</strong>: Write System Prompts that control model output format, style, and depth; understand how role definition affects data distribution.</li>
<li><strong>Deep understanding of automated data generation pipelines</strong>: Reproduce and improve Self-Instruct and Evol-Instruct algorithms, build domain instruction sets from scratch, understand the "teacher-student" distillation logic behind them.</li>
<li><strong>Learn to construct Chain-of-Thought (CoT) data</strong>: Enhance model logic through explicit reasoning steps, breaking the "black box" mapping of Transformers.</li>
<li><strong>Design data filtering and deduplication mechanisms</strong>: Master advanced cleaning strategies from ROUGE deduplication to semantic vector clustering, ensuring quality and diversity of synthetic data.</li>
</ul>
<blockquote>
<p>Scenario Introduction:
"Imagine your team has just finished pre-training a 70B parameter base model, consuming millions of dollars in compute and reading nearly all text on the internet. At this point, it's like a knowledgeable but introverted librarian, with a mind full of Shakespeare's plays, Python code, and quantum mechanics formulas. Yet when you excitedly type 'Please help me create a weight loss plan' at the demo, the model mechanically continues with '...is a good goal, usually including diet and exercise,' or even starts writing 'definition of weight loss plan,' then generates a pile of Wikipedia-style nonsense.</p>
</blockquote>
<p>Why does this happen? Because the base model's training objective is 'predict the next token'—it doesn't understand the interaction pattern of 'instruction' and 'response.' To turn this 'scholar' into a personal assistant that understands your intent, you need to feed it thousands of high-quality Q&amp;A pairs, teaching it how to speak and how to solve problems step by step. But manually writing 100,000 instructions is expensive and slow, and human imagination is often limited to specific patterns. How can we automatically produce high-quality training data that is both complex and diverse without relying on large-scale human annotation? This is the core engineering challenge this chapter addresses."</p>
<hr>
<h2 id="91-core-concepts-and-principles-concepts-principles">9.1. Core Concepts and Principles (Concepts &amp; Principles)<a class="headerlink" href="#91-core-concepts-and-principles-concepts-principles" title="Permanent link">¶</a></h2>
<p>In the SFT phase, the industry has reached consensus: <strong>data quality matters far more than quantity</strong>. The data we need is not merely "input-output" pairs, but samples covering various task types, complexity levels, and reasoning patterns.</p>
<h3 id="911-why-quality-matters-more-than-quantity-the-surface-form-hypothesis">9.1.1 Why Quality Matters More Than Quantity? — The Surface Form Hypothesis<a class="headerlink" href="#911-why-quality-matters-more-than-quantity-the-surface-form-hypothesis" title="Permanent link">¶</a></h3>
<p>Many beginners mistakenly believe SFT is for "learning new knowledge." However, based on findings from classic studies like LIMA (Less Is More for Alignment), the core role of SFT is <strong>not</strong> to inject knowledge, but to <strong>align format</strong>.</p>
<p><strong>The Surface Form Hypothesis</strong> posits that models have already acquired the vast majority of world knowledge and logical ability during pre-training. SFT merely teaches the model a specific "interaction format" or "style" to extract the latent capabilities from pre-training. In other words, if pre-training is like having the model read an entire library, SFT only teaches it how to answer in a tone humans prefer—not the content of the books.</p>
<p>This explains why model performance drops sharply once data contains errors, noise, or logical gaps—because the model is learning "how to index knowledge." If the index is wrong, no amount of knowledge can be correctly retrieved. Therefore, a few thousand high-quality, high-diversity samples often train better models than millions of low-quality, homogeneous samples.</p>
<h3 id="912-engineering-perspective-on-prompt-engineering">9.1.2 Engineering Perspective on Prompt Engineering<a class="headerlink" href="#912-engineering-perspective-on-prompt-engineering" title="Permanent link">¶</a></h3>
<p>In data synthesis, Prompts are no longer simple dialogue inputs but the source code for generating data. We treat Prompts as programmable modules, controlling synthesized data distribution through iterative optimization. An excellent Prompt system typically includes:</p>
<ul>
<li><strong>System Prompt</strong>: Defines the "persona" and "boundaries" of the data generator. This is not just assigning an identity—it activates the model's latent domain-specific vocabulary distribution through role-playing. For example, playing "strict lawyer" vs. "enthusiastic salesperson" generates distinctly different sentence structures.</li>
<li><strong>Few-Shot Examples</strong>: Anchor output format and style through In-Context Learning. These examples serve as "denoising," telling the model "this is the standard answer I want."</li>
<li><strong>Negative Constraints</strong>: Explicitly prohibit the model from generating certain data patterns. In LLM generation, models tend to be lazy or use common clichés; negative constraints are key to breaking this statistical inertia (e.g., "Do not use 'Once upon a time there was a mountain' as story opening").</li>
</ul>
<h3 id="913-automated-construction-methodology">9.1.3 Automated Construction Methodology<a class="headerlink" href="#913-automated-construction-methodology" title="Permanent link">¶</a></h3>
<p>To break through the bottleneck of human data, the industry has evolved two core strategies. Understanding their differences is crucial for building balanced datasets.</p>
<ul>
<li><strong>Self-Instruct</strong>: Focuses on <strong>breadth</strong>. Uses strong models (e.g., GPT-4) to generate many new tasks from few seed tasks. Its core assumption: the model has seen enough task types; we only need to induce them through prompts.</li>
<li><strong>Evol-Instruct</strong>: Focuses on <strong>depth</strong>. Rewrites simple instructions into complex ones through specific evolution operators (e.g., "add constraints," "deepen reasoning"). This directly addresses Self-Instruct's tendency to generate simple, short instructions, forcing the model to climb in logical complexity and constraint satisfaction.</li>
</ul>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../images/part4/%E5%9B%BE9_1_%E8%87%AA%E6%88%91%E6%8C%87%E4%BB%A4%E5%92%8C%E8%BF%9B%E5%8C%96%E6%8C%87%E4%BB%A4%E5%AF%B9%E6%AF%94.png" data-desc-position="bottom"><img alt="Figure 9-1: Self-Instruct vs. Evol-Instruct Comparison" src="../../../images/part4/%E5%9B%BE9_1_%E8%87%AA%E6%88%91%E6%8C%87%E4%BB%A4%E5%92%8C%E8%BF%9B%E5%8C%96%E6%8C%87%E4%BB%A4%E5%AF%B9%E6%AF%94.png"></a>
<em>Figure 9-1: Self-Instruct vs. Evol-Instruct Comparison</em></p>
<p><strong>Table 9-1: Comparison of Mainstream Instruction Data Construction Strategies</strong></p>
<table>
<thead>
<tr>
<th style="text-align: left;">Feature</th>
<th style="text-align: left;">Manual Annotation</th>
<th style="text-align: left;">Self-Instruct</th>
<th style="text-align: left;">Evol-Instruct</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Core Goal</strong></td>
<td style="text-align: left;">Extremely high precision, domain-specific knowledge</td>
<td style="text-align: left;">Increase task diversity</td>
<td style="text-align: left;">Increase task complexity</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Cost</strong></td>
<td style="text-align: left;">Very high (<span class="arithmatex">\(1-\)</span>10/item)</td>
<td style="text-align: left;">Low ($0.01/item)</td>
<td style="text-align: left;">Medium ($0.03/item, requires multi-round calls)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Input Source</strong></td>
<td style="text-align: left;">Domain experts</td>
<td style="text-align: left;">Seed task pool</td>
<td style="text-align: left;">Existing simple instructions</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Operation Logic</strong></td>
<td style="text-align: left;">Expert authorship and review</td>
<td style="text-align: left;">"Generate a new task different from existing tasks"</td>
<td style="text-align: left;">"Rewrite this task to be harder, e.g., add constraints"</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Typical Operators/Methods</strong></td>
<td style="text-align: left;">Cleaning, review, crowdsourcing</td>
<td style="text-align: left;">ROUGE deduplication, noun/verb filtering</td>
<td style="text-align: left;">Deepening evolution, Breadth evolution</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Use Cases</strong></td>
<td style="text-align: left;">Core business logic, RLHF golden datasets</td>
<td style="text-align: left;">General task coverage expansion, cold start</td>
<td style="text-align: left;">Enhancing code, math, and logical reasoning</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Potential Risks</strong></td>
<td style="text-align: left;">Scale difficult; quality fluctuates due to fatigue</td>
<td style="text-align: left;">Prone to homogeneous, simple instructions</td>
<td style="text-align: left;">May generate overly complex or unsolvable "hallucinated instructions"</td>
</tr>
</tbody>
</table>
<h3 id="914-chain-of-thought-cot-data-breaking-the-reasoning-black-box">9.1.4 Chain-of-Thought (CoT) Data: Breaking the Reasoning Black Box<a class="headerlink" href="#914-chain-of-thought-cot-data-breaking-the-reasoning-black-box" title="Permanent link">¶</a></h3>
<p>CoT's core lies in breaking the "input → output" black-box mapping, forcing the model to make implicit reasoning explicit.</p>
<p>From a cognitive science perspective, humans perform a series of intermediate computations mentally when solving complex problems (e.g., math). Although Transformer models are powerful, without CoT training they tend to guess answers directly—like asking students to write the answer without showing their work, which is highly error-prone. CoT data activates the Transformer's intermediate computation layers, allowing it to allocate more compute to difficult problems by extending the generated token sequence (More compute time = More tokens generated).</p>
<h3 id="915-data-format-standardization-data-formatting-standards">9.1.5 Data Format Standardization (Data Formatting Standards)<a class="headerlink" href="#915-data-format-standardization-data-formatting-standards" title="Permanent link">¶</a></h3>
<p>Before engineering implementation, we must understand how data is "fed" to the model. This is not just a JSON parsing issue but relates to how the model understands conversation history. The industry mainly adopts <strong>ChatML</strong> (Chat Markup Language) format, which clearly distinguishes System, User, and Assistant boundaries and prevents prompt injection attacks.</p>
<p>Note that during training, we typically only compute Loss on tokens in the <code>assistant</code> response, while masking <code>system</code> and <code>user</code> parts. This is because we want the model to learn "how to answer," not "how to ask."</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1">// ChatML format example</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="p">{</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">  </span><span class="nt">"messages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="p">{</span><span class="nt">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system"</span><span class="p">,</span><span class="w"> </span><span class="nt">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"You are a helpful assistant."</span><span class="p">},</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="p">{</span><span class="nt">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w"> </span><span class="nt">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Explain quantum entanglement."</span><span class="p">},</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="p">{</span><span class="nt">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"assistant"</span><span class="p">,</span><span class="w"> </span><span class="nt">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Quantum entanglement is a phenomenon..."</span><span class="p">}</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">  </span><span class="p">]</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">}</span>
</code></pre></div>
<hr>
<h2 id="92-engineering-implementation-engineering-implementation">9.2. Engineering Implementation (Engineering Implementation)<a class="headerlink" href="#92-engineering-implementation-engineering-implementation" title="Permanent link">¶</a></h2>
<p>This section guides building a complete data synthesis pipeline, involving toolchain selection and pipeline stability design.</p>
<h3 id="environmentdependencies">Environment/Dependencies<a class="headerlink" href="#environmentdependencies" title="Permanent link">¶</a></h3>
<ul>
<li><code>langchain</code> / <code>langsmith</code>: For managing Prompt templates, LLM call chains, and tracking debugging.</li>
<li><code>rouge_score</code>: For computing text similarity and deduplication.</li>
<li><code>numpy / scikit-learn</code>: For vectorized deduplication (advanced), computing semantic distance via Embedding.</li>
<li><code>openai</code> or <code>vllm</code>: For calling teacher models. vLLM is suitable for locally deployed high-throughput open-source teacher models (e.g., Mixtral-8x7B).</li>
<li><code>chromadb</code> / <code>faiss</code>: Vector databases for large-scale deduplication and retrieval.</li>
</ul>
<h3 id="921-prompt-engineering-for-data-production">9.2.1 Prompt Engineering for Data Production<a class="headerlink" href="#921-prompt-engineering-for-data-production" title="Permanent link">¶</a></h3>
<p>In synthetic data engineering, Prompts must be highly robust. We adopt iterative thinking to refine the System Prompt, like developing software versions.</p>
<h4 id="task-objective-construct-a-batch-of-instruction-data-for-training-a-financial-analysis-assistant">Task Objective: Construct a batch of instruction data for training a "Financial Analysis Assistant."<a class="headerlink" href="#task-objective-construct-a-batch-of-instruction-data-for-training-a-financial-analysis-assistant" title="Permanent link">¶</a></h4>
<p><strong>Step 1: Iteratively Write System Prompt</strong>
* <strong>V1: Too simple, leading to data homogenization</strong>
    * <strong>Defect analysis</strong>: Model-generated instructions tend to be very short and concentrated on basic concept explanations (e.g., "What is a stock?"). This reflects LLM's default tendency to generate "high-probability, low-complexity" text.
    </p><div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># V1 Prompt - Poor performance</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">system_prompt_v1</span> <span class="o">=</span> <span class="s2">"""</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="s2">You are a financial expert. Please generate 5 questions and answers about finance.</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="s2">"""</span>
</code></pre></div><p></p>
<ul>
<li>
<p><strong>V2: Add structured requirements</strong></p>
<ul>
<li><strong>Improvement</strong>: Introduced JSON format requirements for easier parsing. Added "role" setting to guide style.</li>
<li><strong>Defect analysis</strong>: Although format is correct, content still lacks depth, no reasoning process. Model may only generate textbook-style definitions, not practical scenarios.
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># V2 Prompt - Structural improvement</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">system_prompt_v2</span> <span class="o">=</span> <span class="s2">"""</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="s2">You are a Senior Financial Analyst with 20 years of experience.</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="s2">Generate 5 pairs of instruction-response data focused on corporate finance.</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="s2">Format the output as a JSON list.</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="s2">Each item should have: 'instruction', 'input' (optional), 'output'.</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="s2">"""</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p><strong>V3: Final production-ready version</strong></p>
<ul>
<li><strong>Improvement</strong>: Introduced Few-Shot, Negative Constraints, and Complexity Requirements. This is the standard paradigm used in industry.</li>
<li><strong>In-depth analysis</strong>: Through explicit "Anti-Patterns," we cut off the model's path to generating "nonsense." Exemplars are not just format references but anchors for thinking depth.</li>
</ul>
<p></p><div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># V3 Prompt - High robustness production version</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">system_prompt_v3</span> <span class="o">=</span> <span class="s2">"""</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="s2">### ROLE</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="s2">You are a Chief Market Strategist at a top-tier investment bank. Your goal is to train a junior analyst model. You demand precision, depth, and actionable insights.</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="s2">### OBJECTIVE</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="s2">Generate 5 high-quality, complex instruction-following examples related to market analysis, risk management, or quantitative trading.</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="s2">### CONSTRAINTS</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="s2">1. **Complexity**: Do NOT ask simple definitional questions (e.g., "What is a bond?"). Instead, ask for scenario analysis, portfolio adjustments, or impact assessments.</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="s2">2. **Format**: Strictly output a valid JSON list.</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="s2">3. **Reasoning**: The 'output' must demonstrate step-by-step analytical reasoning before giving the conclusion.</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="s2">4. **Anti-Patterns**:</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="s2">   - Avoid generic advice like "Consult a financial advisor."</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="s2">   - Avoid short, one-sentence responses.</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="s2">   - Avoid vague statements; use numbers and specific financial instruments where possible.</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="s2">### OUTPUT FORMAT</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="s2">[</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="s2">  {</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="s2">    "instruction": "...",</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="s2">    "input_context": "..." (can be null),</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="s2">    "output": "..."</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="s2">  }</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="s2">]</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="s2">### EXEMPLAR (One-Shot)</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="s2">[</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a><span class="s2">  {</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="s2">    "instruction": "Given a portfolio heavily weighted in tech stocks (60%), analyze the impact of a sudden 50bps rate hike by the Fed.",</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="s2">    "input_context": null,</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="s2">    "output": "First, we identify the correlation... Tech stocks are long-duration assets... Discounted Cash Flow (DCF) models would show... Therefore, the portfolio would likely suffer significant drawdown. I recommend hedging via..."</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="s2">  }</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a><span class="s2">]</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a><span class="s2">"""</span>
</code></pre></div>
<strong>Pro Tip:</strong> In V3, we made "Anti-Patterns" explicit. This is key to preventing the model from "slacking." LLMs tend to generate safe, mediocre answers (e.g., "please consult a professional"), which are low-value noise in training data and must be explicitly prohibited.<p></p>
</li>
</ul>
<h3 id="922-automated-construction-methods-self-instruct-and-evol-instruct">9.2.2 Automated Construction Methods: Self-Instruct and Evol-Instruct<a class="headerlink" href="#922-automated-construction-methods-self-instruct-and-evol-instruct" title="Permanent link">¶</a></h3>
<p>We implement a simplified pipeline based on Evol-Instruct. The core is how to "evolve" simple instructions into complex ones through Prompts, with verification mechanisms introduced in the process.</p>
<h4 id="core-code-breakdown-evol-instruct-pipeline">Core Code Breakdown: Evol-Instruct Pipeline<a class="headerlink" href="#core-code-breakdown-evol-instruct-pipeline" title="Permanent link">¶</a></h4>
<p><strong>Step 1: Define Evolution Operators (Evolution Prompts)</strong></p>
<p>The essence of Evol-Instruct lies in this set of Prompt templates. We need to define different evolution directions: depth (add constraints, deepen reasoning) and breadth (mutation). The following code shows how to build Prompts for "add constraints" and "deepen reasoning." The design of these Prompts directly determines the upper limit of data quality.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">EvolutionPrompts</span><span class="p">:</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_deepening_prompt</span><span class="p">(</span><span class="n">instruction</span><span class="p">):</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="sd">        Depth evolution: Increase logical reasoning depth.</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="sd">        By requiring 'explicitly ask for multiple-step reasoning', force the model from intuitive to analytical answers.</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="sd">        """</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"""</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="s2">        I want you to act as a Prompt Rewriter.</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="s2">        Your objective is to rewrite a given prompt into a more complex version to make those famous AI systems (e.g., ChatGPT and GPT4) a bit harder to handle.</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="s2">        But the rewritten prompt must be reasonable and must be understood and responded by humans.</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="s2">        # Given Prompt #:</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="s2">        </span><span class="si">{</span><span class="n">instruction</span><span class="si">}</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="s2">        # Method #:</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="s2">        If #Given Prompt# can be solved with just a few simple thinking processes, you can rewrite it to explicitly ask for multiple-step reasoning.</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="s2">        # Rewritten Prompt #:</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="s2">        """</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_constraints_prompt</span><span class="p">(</span><span class="n">instruction</span><span class="p">):</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="sd">        Depth evolution: Add specific constraints.</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="sd">        Limit word increase (10-20 words) to prevent instructions from becoming verbose without substance.</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="sd">        """</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"""</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="s2">        I want you to act as a Prompt Rewriter.</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="s2">        ... [header omitted for brevity]...</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a><span class="s2">        # Given Prompt #:</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a><span class="s2">        </span><span class="si">{</span><span class="n">instruction</span><span class="si">}</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a><span class="s2">        # Method #:</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a><span class="s2">        Please add one more constraint/requirement into #Given Prompt#.</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a><span class="s2">        You should try your best not to make the #Rewritten Prompt# become verbose, #Rewritten Prompt# can only add 10 to 20 words into #Given Prompt#.</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a><span class="s2">        # Rewritten Prompt #:</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a><span class="s2">        """</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_breadth_prompt</span><span class="p">(</span><span class="n">instruction</span><span class="p">):</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a><span class="sd">        Breadth evolution: Generate entirely new instructions on different topics based on existing ones.</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a><span class="sd">        Prevents data distribution collapse into narrow domains.</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a><span class="sd">        """</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"""</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a><span class="s2">        I want you to act as a Prompt Creator.</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a><span class="s2">        Please generate a brand new prompt that has the same difficulty level as #Given Prompt# but covers a completely different topic or domain.</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a><span class="s2">        # Given Prompt #:</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a><span class="s2">        </span><span class="si">{</span><span class="n">instruction</span><span class="si">}</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a><span class="s2">        # New Prompt #:</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a><span class="s2">        """</span>
</code></pre></div>
<p><strong>Step 2: Execute Evolution Loop and Exception Handling</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="c1"># Assume we have an LLM call interface</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">call_llm</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="c1"># Call GPT-4 or other strong model</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="c1"># In production, add retry mechanisms for network jitter</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="k">pass</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">evolve_instruction</span><span class="p">(</span><span class="n">base_instruction</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="n">current_instruction</span> <span class="o">=</span> <span class="n">base_instruction</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>        <span class="c1"># Randomly select an evolution strategy</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>        <span class="c1"># Strategy probability can be adjusted; e.g., more Breadth early, more Deepening later</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>        <span class="n">strategy</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">'deepening'</span><span class="p">,</span> <span class="s1">'constraints'</span><span class="p">,</span> <span class="s1">'breadth'</span><span class="p">])</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">'deepening'</span><span class="p">:</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>            <span class="n">prompt</span> <span class="o">=</span> <span class="n">EvolutionPrompts</span><span class="o">.</span><span class="n">get_deepening_prompt</span><span class="p">(</span><span class="n">current_instruction</span><span class="p">)</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">'constraints'</span><span class="p">:</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>            <span class="n">prompt</span> <span class="o">=</span> <span class="n">EvolutionPrompts</span><span class="o">.</span><span class="n">get_constraints_prompt</span><span class="p">(</span><span class="n">current_instruction</span><span class="p">)</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>            <span class="n">prompt</span> <span class="o">=</span> <span class="n">EvolutionPrompts</span><span class="o">.</span><span class="n">get_breadth_prompt</span><span class="p">(</span><span class="n">current_instruction</span><span class="p">)</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        <span class="c1"># Get evolved instruction</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>        <span class="n">evolved_candidate</span> <span class="o">=</span> <span class="n">call_llm</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>        <span class="c1"># Quality check (simple): Prevent evolution failure</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>        <span class="c1"># Often models output "Sorry, I can't do that" or simply repeat the original</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>        <span class="k">if</span> <span class="s2">"sorry"</span> <span class="ow">in</span> <span class="n">evolved_candidate</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">evolved_candidate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Evolution failed at step </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, keeping previous instruction."</span><span class="p">)</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>            <span class="k">break</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>        <span class="c1"># Advanced check: Simple heuristic to detect simple repetition</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>        <span class="k">if</span> <span class="n">evolved_candidate</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">current_instruction</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Evolution stagnant at step </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>             <span class="k">break</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>        <span class="n">current_instruction</span> <span class="o">=</span> <span class="n">evolved_candidate</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>    <span class="k">return</span> <span class="n">current_instruction</span>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a><span class="c1"># Example run</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a><span class="n">seed</span> <span class="o">=</span> <span class="s2">"Write a Python script to calculate Fibonacci numbers."</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a><span class="n">complex_instruction</span> <span class="o">=</span> <span class="n">evolve_instruction</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a><span class="c1"># Expected result: "Write a Python script to calculate the nth Fibonacci number using dynamic programming, optimize for memory usage, and handle negative input values."</span>
</code></pre></div>
<p><strong>Step 3: Performance Optimization Tips</strong>
* <strong>Batch Processing:</strong> Don't call the API one by one. Construct a Prompt list with 20 instructions, let the model return 20 evolved results at once. This significantly reduces token cost and network latency (High Throughput).
* <strong>Failure Filter:</strong> Evolution often fails (e.g., model starts repeating). Implement a filter: if evolved instruction length shortened or contains typical refusal phrases ("As an AI..."), discard the sample.
* <strong>Diversity Control:</strong> In batch generation, explicitly require "Generate diverse topics" in the System Prompt to avoid all instructions in one batch being about "Python programming."</p>
<h3 id="923-chain-of-thought-cot-data-constructing-step-by-step-reasoning-samples">9.2.3 Chain-of-Thought (CoT) Data: Constructing Step-by-Step Reasoning Samples<a class="headerlink" href="#923-chain-of-thought-cot-data-constructing-step-by-step-reasoning-samples" title="Permanent link">¶</a></h3>
<p>The core value of SFT data lies in teaching the model "how to think." Ordinary Q&amp;A pairs (Q: 1+1? A: 2) only teach the result; CoT teaches the process.</p>
<h4 id="cot-data-construction-prompt-template">CoT Data Construction Prompt Template<a class="headerlink" href="#cot-data-construction-prompt-template" title="Permanent link">¶</a></h4>
<p>We don't just add "Let's think step by step"—we require the model to output in a specific format (e.g., <code>&lt;thinking&gt;</code> tags). This formatted data is highly useful in subsequent training; we can choose to have the model output the thinking process or hide it during inference.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># System Prompt for CoT Generation</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">cot_system_prompt</span> <span class="o">=</span> <span class="s2">"""</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="s2">You are a reasoning expert. When answering the user's question, you MUST follow this format:</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="s2">1. Enclose your thought process in &lt;thinking&gt; tags.</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="s2">2. Break down the problem into logical steps.</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="s2">3. Check for edge cases or potential errors in your logic (Self-Correction).</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="s2">4. Output the final answer in &lt;answer&gt; tags.</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="s2">Do NOT output the answer directly without the thinking process.</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="s2">"""</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="c1"># V3 Prompt Iteration for Math CoT</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="n">user_prompt_cot</span> <span class="o">=</span> <span class="s2">"""</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="s2">Question: A farmer has chickens and cows. There are 20 heads and 50 legs. How many of each are there?</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="s2">Please provide a Step-by-Step solution.</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="s2">"""</span>
</code></pre></div>
<p><strong>Example output (as training data):</strong>
</p><div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nt">&lt;thinking&gt;</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>Step<span class="w"> </span>1:<span class="w"> </span>Define<span class="w"> </span>variables.<span class="w"> </span>Let<span class="w"> </span>C<span class="w"> </span>be<span class="w"> </span>chickens,<span class="w"> </span>K<span class="w"> </span>be<span class="w"> </span>cows.
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>Step<span class="w"> </span>2:<span class="w"> </span>Set<span class="w"> </span>up<span class="w"> </span>equations<span class="w"> </span>based<span class="w"> </span>on<span class="w"> </span>the<span class="w"> </span>problem<span class="w"> </span>statement.
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">   </span>Equation<span class="w"> </span>1<span class="w"> </span>(Heads):<span class="w"> </span>C<span class="w"> </span>+<span class="w"> </span>K<span class="w"> </span>=<span class="w"> </span>20
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">   </span>Equation<span class="w"> </span>2<span class="w"> </span>(Legs):<span class="w"> </span>2C<span class="w"> </span>+<span class="w"> </span>4K<span class="w"> </span>=<span class="w"> </span>50
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>Step<span class="w"> </span>3:<span class="w"> </span>Solve<span class="w"> </span>for<span class="w"> </span>C<span class="w"> </span>from<span class="w"> </span>Equation<span class="w"> </span>1.<span class="w"> </span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">   </span>C<span class="w"> </span>=<span class="w"> </span>20<span class="w"> </span>-<span class="w"> </span>K.
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>Step<span class="w"> </span>4:<span class="w"> </span>Substitute<span class="w"> </span>C<span class="w"> </span>into<span class="w"> </span>Equation<span class="w"> </span>2.
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">   </span>2(20<span class="w"> </span>-<span class="w"> </span>K)<span class="w"> </span>+<span class="w"> </span>4K<span class="w"> </span>=<span class="w"> </span>50
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">   </span>40<span class="w"> </span>-<span class="w"> </span>2K<span class="w"> </span>+<span class="w"> </span>4K<span class="w"> </span>=<span class="w"> </span>50
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">   </span>2K<span class="w"> </span>=<span class="w"> </span>10<span class="w"> </span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">   </span>K<span class="w"> </span>=<span class="w"> </span>5.
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>Step<span class="w"> </span>5:<span class="w"> </span>Solve<span class="w"> </span>for<span class="w"> </span>C<span class="w"> </span>using<span class="w"> </span>the<span class="w"> </span>value<span class="w"> </span>of<span class="w"> </span>K.<span class="w"> </span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">   </span>C<span class="w"> </span>=<span class="w"> </span>20<span class="w"> </span>-<span class="w"> </span>5<span class="w"> </span>=<span class="w"> </span>15.
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>Step<span class="w"> </span>6:<span class="w"> </span>Verify<span class="w"> </span>the<span class="w"> </span>solution.<span class="w"> </span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">   </span>Heads:<span class="w"> </span>15<span class="w"> </span>+<span class="w"> </span>5<span class="w"> </span>=<span class="w"> </span>20.<span class="w"> </span>Correct.
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">   </span>Legs:<span class="w"> </span>15*2<span class="w"> </span>+<span class="w"> </span>5*4<span class="w"> </span>=<span class="w"> </span>30<span class="w"> </span>+<span class="w"> </span>20<span class="w"> </span>=<span class="w"> </span>50.<span class="w"> </span>Correct.
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="nt">&lt;/thinking&gt;</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="nt">&lt;answer&gt;</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>Chickens:<span class="w"> </span>15,<span class="w"> </span>Cows:<span class="w"> </span>5
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="nt">&lt;/answer&gt;</span>
</code></pre></div>
<strong>Pro Tip:</strong> This data strategy with <code>&lt;thinking&gt;</code> tags is called "Internal Monologue" training. During SFT, keep these tags so the model learns to output the thinking process. In production, use parsing code to capture <code>&lt;thinking&gt;</code> content and only show <code>&lt;answer&gt;</code> to users, or implement a "Thinking..." UI animation showing partial reasoning steps for explainability.<p></p>
<hr>
<h2 id="924-performance-and-evaluation-performance-evaluation">9.2.4. Performance and Evaluation (Performance &amp; Evaluation)<a class="headerlink" href="#924-performance-and-evaluation-performance-evaluation" title="Permanent link">¶</a></h2>
<p>Data generation is only the first step; how to evaluate generated data quality is equally critical. We cannot wait until model training completes (potentially days and thousands of dollars) to discover poor data quality.</p>
<h3 id="evaluation-metrics">Evaluation Metrics<a class="headerlink" href="#evaluation-metrics" title="Permanent link">¶</a></h3>
<ul>
<li><strong>Instruction Following Rate:</strong> Usually an automated test. Use GPT-4 as judge to determine whether model-generated responses strictly satisfy all constraints in the input (e.g., "word limit," "include specific keywords," "JSON format").</li>
<li><strong>Complexity Distribution:</strong> Use NLP tools (e.g., SpaCy) to analyze verb diversity, syntactic tree depth, and average length of generated instructions. Plot distribution histograms to ensure Evol-Instruct truly increased difficulty, not just verbosity.</li>
<li><strong>Diversity:</strong> Compute ROUGE-L or use Embedding Cosine Similarity. If average similarity between samples in the dataset is too high, "mode collapse" has occurred—data lacks diversity.</li>
</ul>
<h3 id="benchmarks">Benchmarks<a class="headerlink" href="#benchmarks" title="Permanent link">¶</a></h3>
<p>In academia and industry, there are recognized benchmarks for testing post-SFT model capability:
* <strong>WizardLM paper data:</strong> Models trained on data evolved through 4 rounds of Evol-Instruct typically show 10%-20%+ improvement on GSM8K (math) and HumanEval (code) compared to models using only raw data.
* <strong>MT-Bench:</strong> A multi-turn dialogue evaluation set specifically testing instruction following, reasoning, and multi-turn dialogue ability, typically scored by GPT-4.
* <strong>Cost reference:</strong> Generating 52K Self-Instruct data using <code>gpt-3.5-turbo</code> costs approximately <span class="arithmatex">\(500-\)</span>1000 (depending on Prompt length and rounds). This is highly cost-effective compared to hundreds of thousands of dollars for manual annotation.</p>
<hr>
<h2 id="925-pitfalls-troubleshooting">9.2.5. Pitfalls &amp; Troubleshooting<a class="headerlink" href="#925-pitfalls-troubleshooting" title="Permanent link">¶</a></h2>
<p>In practice, data synthesis is full of pitfalls. Here are common failure modes and solutions.</p>
<ul>
<li>
<p><strong>Pitfall 1: Mode Collapse</strong></p>
<ul>
<li><strong>Symptom:</strong> Model-generated instructions are monotonous—e.g., 1000 generated samples are all "Please write an article about X" or "Please write a Python function."</li>
<li><strong>Cause:</strong> Seed tasks too homogeneous, or System Prompt Temperature set too low, causing the model to fall into local optima.</li>
<li><strong>Fix:</strong> Increase Seed Task diversity (cover 100+ domains: cooking, law, programming, literature); raise Temperature (0.7 → 1.0); explicitly require "Generate a task from a domain different from previous examples" in System Prompt.</li>
</ul>
</li>
<li>
<p><strong>Pitfall 2: Hallucinated Constraints</strong></p>
<ul>
<li><strong>Symptom:</strong> Model learns "must output JSON" from training data, causing it to force JSON output even for casual chat ("Hello"), or output <code>&lt;thinking&gt;</code> tags when not requested.</li>
<li><strong>Cause:</strong> Severely skewed training data distribution—100% complex instructions, lacking simple general dialogue data.</li>
<li><strong>Fix:</strong> Data mixing. Mix 10%-20% general dialogue data (e.g., ShareGPT or chit-chat) into Evol-Instruct data to prevent overfitting to specific formats. This is called "General Capability Replay."</li>
</ul>
</li>
<li>
<p><strong>Pitfall 3: Evolution Failure (Degradation)</strong></p>
<ul>
<li><strong>Symptom:</strong> Evolved instructions become absurd, logically contradictory ("Write a 1000-word article without vowels") or extremely verbose.</li>
<li><strong>Fix:</strong> Implement "length penalty" or "complexity truncation." If evolved instructions are complex but GPT-4 cannot answer (or answer quality is poor), the sample is invalid (Bad Case). Introduce "teacher model scoring" for GPT-4 to evaluate evolved instruction feasibility.</li>
</ul>
</li>
<li>
<p><strong>Pitfall 4: Catastrophic Forgetting</strong></p>
<ul>
<li><strong>Symptom:</strong> After SFT, the model learns to follow instructions but seems "dumber," forgetting some world knowledge from pre-training.</li>
<li><strong>Cause:</strong> SFT dataset modifies model weight distribution, over-focusing on specific task forms and squeezing general knowledge storage.</li>
<li><strong>Fix:</strong> Lower learning rate, reduce epochs (SFT typically only needs 2-3 epochs). Add small amounts of pre-training data (Pre-training Replay) to SFT data to maintain parameter distribution stability.</li>
</ul>
</li>
</ul>
<hr>
<h2 id="926-chapter-summary-and-further-reading">9.2.6. Chapter Summary and Further Reading<a class="headerlink" href="#926-chapter-summary-and-further-reading" title="Permanent link">¶</a></h2>
<p>We treat Prompts as the source code of data—they must be managed with rigorous version control and iterative testing like software engineering code. In this framework, Self-Instruct solves the "from zero to one" cold-start challenge, while Evol-Instruct conquers the "from easy to hard" complexity climb. Their organic combination constitutes the golden paradigm for building high-performance datasets. Meanwhile, Chain-of-Thought (CoT) data is far from a simple problem-solving trick—by making reasoning explicit, it effectively allocates computational resources to critical reasoning steps, fundamentally enhancing the model's ability to handle complex logic. Ultimately, the core barrier in data synthesis is not generation capability but the art of filtering and cleaning—between the ease of mass generation and the difficulty of precise screening, only the ability to extract gold from sand truly constitutes core competitiveness.</p>
<h3 id="references-and-further-reading">References and Further Reading<a class="headerlink" href="#references-and-further-reading" title="Permanent link">¶</a></h3>
<ul>
<li><em>Wang, Y., et al. (2022). Self-Instruct: Aligning Language Models with Self-Generated Instructions.</em> (Foundational work on automated instruction generation)</li>
<li><em>Xu, C., et al. (2023). WizardLM: Empowering Large Language Models to Follow Complex Instructions.</em> (Detailed introduction to Evol-Instruct evolution operators)</li>
<li><em>Wei, J., et al. (2022). Chain-of-Thought Prompting Elicits Reasoning in Large Language Models.</em> (Foundational work on CoT)</li>
<li><em>Zhou, C., et al. (2023). LIMA: Less Is More for Alignment.</em> (Establishes theoretical basis that SFT mainly learns format rather than knowledge; "quality &gt; quantity")</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../../part3/3_3_video_audio/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Chapter 8: Video &amp; Audio Data">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Chapter 8: Video &amp; Audio Data
              </div>
            </div>
          </a>
        
        
          
          <a href="../4_2_synthetic_data/" class="md-footer__link md-footer__link--next" aria-label="Next: Chapter 10: Synthetic Data">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Chapter 10: Synthetic Data
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.sections", "navigation.expand", "navigation.indexes", "navigation.top", "navigation.footer", "toc.follow", "search.suggest", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>